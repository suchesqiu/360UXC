<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>../../uxc/comps/Form/UXC.Form.initAutoSelect.js - UXC jquery components</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../uxc.png" title="UXC jquery components"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/UXC.alert.html">UXC.alert</a></li>
            
                <li><a href="../classes/UXC.Calendar.html">UXC.Calendar</a></li>
            
                <li><a href="../classes/UXC.confirm.html">UXC.confirm</a></li>
            
                <li><a href="../classes/UXC.CustomEvent.html">UXC.CustomEvent</a></li>
            
                <li><a href="../classes/UXC.Dialog.html">UXC.Dialog</a></li>
            
                <li><a href="../classes/UXC.Dialog.alert.html">UXC.Dialog.alert</a></li>
            
                <li><a href="../classes/UXC.Dialog.confirm.html">UXC.Dialog.confirm</a></li>
            
                <li><a href="../classes/UXC.Form.html">UXC.Form</a></li>
            
                <li><a href="../classes/UXC.hideAllPopup.html">UXC.hideAllPopup</a></li>
            
                <li><a href="../classes/UXC.LunarCalendar.html">UXC.LunarCalendar</a></li>
            
                <li><a href="../classes/UXC.LunarCalendar.Model.html">UXC.LunarCalendar.Model</a></li>
            
                <li><a href="../classes/UXC.LunarCalendar.View.html">UXC.LunarCalendar.View</a></li>
            
                <li><a href="../classes/UXC.Panel.html">UXC.Panel</a></li>
            
                <li><a href="../classes/UXC.Panel.Model.html">UXC.Panel.Model</a></li>
            
                <li><a href="../classes/UXC.Panel.View.html">UXC.Panel.View</a></li>
            
                <li><a href="../classes/UXC.Toggle.html">UXC.Toggle</a></li>
            
                <li><a href="../classes/UXC.Valid.html">UXC.Valid</a></li>
            
                <li><a href="../classes/window.jQuery.html">window.jQuery</a></li>
            
                <li><a href="../classes/window.UXC.html">window.UXC</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: ../../uxc/comps/Form/UXC.Form.initAutoSelect.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
 ;(function($){
    /**
     * 初始化 级联下拉框
     * &lt;br /&gt;只要引用本脚本, 页面加载完毕时就会自动初始化级联下拉框功能
     * &lt;br /&gt;&lt;br /&gt;动态添加的 DOM 需要显式调用 UXC.Form.initAutoSelect( domSelector ) 进行初始化
     * &lt;br /&gt;&lt;br /&gt;要使页面上的级联下拉框功能能够自动初始化, 需要在select标签上加入一些HTML 属性
     * &lt;br /&gt;&lt;b&gt;defaultselect&lt;/b&gt;: none, 该属性声明这是级联下拉框的第一个下拉框, &lt;b&gt;这是必填项,初始化时以这个为入口&lt;/b&gt;
     * &lt;br /&gt;&lt;b&gt;selectvalue&lt;/b&gt;: string, 下拉框的默认选中值
     * &lt;br /&gt;&lt;b&gt;selecturl&lt;/b&gt;: string, 下拉框的数据请求接口, 符号 {0} 代表下拉框值的占位符
     * &lt;br /&gt;&lt;b&gt;selecttarget&lt;/b&gt;: selector, 下一级下拉框的选择器语法
     * &lt;br /&gt;&lt;b&gt;defaultoption&lt;/b&gt;: none, 声明默认 option 选项, 更新option时, 有该属性的项不会被清除
     * &lt;p&gt;
     *      数据格式: [ [id, name], [id, name] ... ]
     *      &lt;br /&gt; 如果获取到的数据格式不是默认格式,
     *      可以通过 &lt;a href=&#x27;UXC.Form.html#property_initAutoSelect.dataFilter&#x27;&gt;UXC.Form.initAutoSelect.dataFilter&lt;/a&gt; 属性自定义函数, 进行数据过滤
     * &lt;/p&gt;
     * @method  initAutoSelect
     * @static
     * @for UXC.Form
     * @version dev 0.1
     * @author  qiushaowei   &lt;suches@btbtd.org&gt; | 360 UXC-FE Team
     * @date    2013-06-11
     * @param   {selector}  _selector   要初始化的级联下拉框父级节点
     * @example
        &lt;h2&gt;AJAX 返回内容&lt;/h2&gt;
        &lt;code&gt;
            &lt;dd&gt;    
                &lt;select name=&#x27;select102_1&#x27; defaultselect selecturl=&quot;data/shengshi_with_error_code.php?id=0&quot; selecttarget=&quot;select[name=select102_2]&quot;&gt;
                    &lt;option value=&quot;-1&quot; defaultoption&gt;请选择&lt;/option&gt;
                &lt;/select&gt;
                &lt;select name=&#x27;select102_2&#x27; selecturl=&quot;data/shengshi_with_error_code.php?id={0}&quot; selecttarget=&quot;select[name=select102_3]&quot;&gt;
                    &lt;option value=&quot;-1&quot; defaultoption&gt;请选择&lt;/option&gt;
                &lt;/select&gt;
                &lt;select name=&#x27;select102_3&#x27; selecturl=&quot;data/shengshi_with_error_code.php?id={0}&quot;&gt;
                    &lt;option value=&quot;-1&quot; defaultoption&gt;请选择&lt;/option&gt;
                &lt;/select&gt;
            &lt;/dd&gt;
        &lt;/code&gt;
        &lt;script&gt;
            $.get( &#x27;./data/shengshi_html.php?rnd=&#x27;+new Date().getTime(), function( _r ){
                var _selector = $(_r);
                $( &#x27;dl.def &gt; dt&#x27; ).after( _selector );
                UXC.Form.initAutoSelect( _selector );
            });

            UXC.Form.initAutoSelect.dataFilter = 
                function( _data, _select ){
                    var _r = _data;
                    if( _data &amp;&amp; !_data.length &amp;&amp; _data.data ){
                        _r = _data.data;
                    }
                    return _r;
                };
        &lt;/script&gt;
     */
    UXC.Form.initAutoSelect = 
        function( _selector ){
            _selector = $( _selector );
            _selector.find( &#x27;select[defaultselect]&#x27; ).each( function(){
                var _tmp = getSelectList( this );
                if( !(_tmp &amp;&amp; _tmp.length ) ) return;
                $.each( _tmp, function( _ix, _item ){
                    $(_item).on(&#x27;change&#x27;, changeEvent);
                });
                $(_tmp[ _tmp.length - 1 ]).data(&#x27;isLastSelect&#x27;, true);
                $(_tmp[0]).data(&#x27;isFirstSelect&#x27;, true);
                _tmp[0].trigger(&#x27;change&#x27;);
            });
        };
    /**
     * 是否自动隐藏空值的级联下拉框, 起始下拉框不会被隐藏
     * @property    initAutoSelect.hideEmpty
     * @type    bool
     * @default false
     * @static
     * @example
            UXC.Form.initAutoSelect.hideEmpty = true;
     */
    UXC.Form.initAutoSelect.hideEmpty = false;
    /**
     * 级联下拉框的数据过滤函数
     * &lt;br /&gt;默认数据格式: [ [id, name], [id, name] ... ]
     * &lt;br /&gt;如果获取到的数据格式非默认格式, 可通过本函数进行数据过滤
     * &lt;p&gt;&lt;b&gt;注意, 这个是全局过滤, 如果要使用该函数进行数据过滤, 判断逻辑需要比较具体&lt;/b&gt;&lt;/p&gt;
     * @property    initAutoSelect.dataFilter
     * @type    function
     * @default undefined
     * @static
     * @example
             UXC.Form.initAutoSelect.dataFilter = 
                function( _data, _select ){
                    var _r = _data;
                    if( _data &amp;&amp; !_data.length &amp;&amp; _data.data ){
                        _r = _data.data;
                    }
                    return _r;
                };
     */
    UXC.Form.initAutoSelect.dataFilter;
    /**
     * 页面加载完毕时, 延时进行自动化, 延时可以避免来自其他逻辑的干扰
     */
    $(document).ready( function( _evt ){
        setTimeout( function(){ UXC.Form.initAutoSelect( document ); }, 100 );
    });
    /**
     * 下拉框改变选项时的响应函数
     * @method  initAutoSelect.changeEvent
     * @private
     * @static
     * @param   {event}   _evt  dom event
     */
    function changeEvent( _evt ){
        var _p = $(this), _val;
        UXC.log( _p.prop( &#x27;name&#x27; ) );

        if( _p.is(&#x27;[selectvalue]&#x27;) ){
            _val = $.trim( _p.attr(&#x27;selectvalue&#x27;) );
            _p.removeAttr( &#x27;selectvalue&#x27; );
            UXC.log( 1, &#x27;_val&#x27;, _val );
            if( hasVal( _p, _val ) ){
                UXC.log( 1, 1 );
                _p.val( _val );
                var _selectval = _val;
                if( _p.is( &#x27;[selecttarget]&#x27; ) ){
                    var _target = $(_p.attr(&#x27;selecttarget&#x27;));
                    if( _target.is( &#x27;[selectvalue]&#x27; ) ){
                        _selectval = _target.attr(&#x27;selectvalue&#x27;);
                        _target.removeAttr(&#x27;selectvalue&#x27;);
                    }
                    if( _target.is( &#x27;[selecturl]&#x27; ) ){
                        var  _reqval = _val
                            , _url = add_url_params( _target.attr( &#x27;selecturl&#x27; ), { &#x27;rnd&#x27;: new Date().getTime() } );
                        if( _target.data(&#x27;parentSelect&#x27;) ){
                            _reqval = _target.data(&#x27;parentSelect&#x27;).val();
                        }
                        _url = _url.replace( /\{0\}/g, _reqval );

                        getData( _target, _url, _selectval, triggerChange);
                    }
                }
            }else{
                UXC.log( 1, 2 );
                if( _p.is( &#x27;[selecturl]&#x27; ) ){
                    var  _reqval = _val
                        , _url = add_url_params( _p.attr( &#x27;selecturl&#x27; ), { &#x27;rnd&#x27;: new Date().getTime() } );
                    if( _p.data(&#x27;parentSelect&#x27;) ){
                        _reqval = _p.data(&#x27;parentSelect&#x27;).val();
                    }
                _url = _url.replace( /\{0\}/g, _reqval );

                getData( _p, _url, _val, function( _select ){
                    if( _select.is( &#x27;[selecttarget]&#x27; ) ){
                        var _target = $(_select.attr(&#x27;selecttarget&#x27;));
                        if( _target.is( &#x27;[selectvalue]&#x27; ) ){
                            _val = _target.attr(&#x27;selectvalue&#x27;);
                            _target.removeAttr(&#x27;selectvalue&#x27;);
                        }
                        if( _target.is( &#x27;[selecturl]&#x27; ) ){
                            var  _reqval = _val
                                , _url = add_url_params( _target.attr( &#x27;selecturl&#x27; ), { &#x27;rnd&#x27;: new Date().getTime() } );
                            if( _target.data(&#x27;parentSelect&#x27;) ){
                                _reqval = _target.data(&#x27;parentSelect&#x27;).val();
                            }
                            _url = _url.replace( /\{0\}/g, _reqval );

                            getData( _target, _url, _val, triggerChange);
                        }
                    }
                });
                }
            }
        }else{
            _val = _p.val();
            UXC.log( 2, &#x27;_val&#x27;, _val );
            if( hasItem( _p ) ){
                UXC.log( 2, 1 );
                if( _p.is( &#x27;[selecttarget]&#x27; ) ){
                    UXC.log( 2, 1, 1 );
                    var _target = $( _p.attr(&#x27;selecttarget&#x27;) );
                    var _selectval = _val;
                    if( _target.is( &#x27;[selectvalue]&#x27; ) ){
                        _selectval = _target.attr(&#x27;selectvalue&#x27;);
                        _target.removeAttr(&#x27;selectvalue&#x27;);
                    }

                    if( _target.is( &#x27;[selecturl]&#x27; ) ){
                        UXC.log( 2, 1, 1, 1, _selectval );
                        var  _reqval = _val
                            , _url = add_url_params( _target.attr( &#x27;selecturl&#x27; ), { &#x27;rnd&#x27;: new Date().getTime() } );

                        if( _target.data(&#x27;parentSelect&#x27;) ){
                            _reqval = _target.data(&#x27;parentSelect&#x27;).val();
                        }
                        _url = _url.replace( /\{0\}/g, _reqval );

                        getData( _target, _url, _selectval, triggerChange);
                    }
                }else{
                    UXC.log( 2, 1, 2 );
                    var _target = _p;
                    if( _target.is( &#x27;[selecturl]&#x27; ) ){
                        var  _reqval = _val
                            , _url = add_url_params( _target.attr( &#x27;selecturl&#x27; ), { &#x27;rnd&#x27;: new Date().getTime() } );
                        if( _target.data(&#x27;parentSelect&#x27;) ){
                            _reqval = _target.data(&#x27;parentSelect&#x27;).val();
                        }
                        UXC.log( _reqval );
                        _url = _url.replace( /\{0\}/g, _reqval );
                        /**
                         * 如果是最后一个SELECT, 那么取消数据请求
                         */
                        if( _target.data(&#x27;isLastSelect&#x27;) ){
                            if( ( parseInt( _reqval ) || 0 ) &lt; 1 ){
                                removeOption( _target );
                                UXC.Form.initAutoSelect.hideEmpty &amp;&amp; _target.hide();
                            }
                           return;
                        }
                        getData( _target, _url, _val, triggerChange);
                    }

                }
            }else{
                UXC.log( 2, 2 );
                var _val = &#x27;&#x27;, _url = add_url_params( _p.attr( &#x27;selecturl&#x27; ), { &#x27;rnd&#x27;: new Date().getTime() } );
                _p.data(&#x27;parentSelect&#x27;) &amp;&amp; ( _val = _p.data(&#x27;parentSelect&#x27;).val() );
                _url = _url.replace( /\{0\}/g, _val );

                if( !_p.data(&#x27;isFirstSelect&#x27;) &amp;&amp; ( (parseInt( _val, 10 ) || 0) &lt; 1 ) ){
                    removeOption( _p );
                    triggerChange( _p );
                    UXC.Form.initAutoSelect.hideEmpty &amp;&amp; _p.hide();
                }else getData( _p, _url, _val, triggerChange );
            }
        }
    }//end changeEvent
    /** 
     * 触发下一级下拉框的change事件
     * @method  initAutoSelect.triggerChange
     * @private 
     * @static
     * @param   {selector}  _select     下拉框的选择器对象
     */
    function triggerChange( _select ){
        if( _select.is( &#x27;[selecttarget]&#x27; )  ){
            $( _select.attr(&#x27;selecttarget&#x27;) ).trigger(&#x27;change&#x27;);
        }
    }
    /**
     * AJAX请求数据, 并处理结果
     * @method      initAutoSelect.getData
     * @private
     * @static
     * @param   {selector}  _select     下拉框的选择器对象
     * @param   {string}    _url        请求数据的URL接口
     * @param   {string}    _selectval  默认选中值
     * @param   {function}  _callback   结果处理完毕后的回调函数
     */
    function getData( _select, _url, _selectval, _callback ){
        $.getJSON( _url, function( _r ){
            //TODO: 这里应该添加返回数据处理回调
            if( UXC.Form.initAutoSelect.dataFilter ){
                _r = UXC.Form.initAutoSelect.dataFilter( _r, _select );
            }
            if( !_r ) return;
            removeOption( _select );

            if( UXC.Form.initAutoSelect.hideEmpty ){
                !_r.length &amp;&amp; _select.hide();
                _r.length &amp;&amp; _select.show();
            }

            var _optls = [];
            for( var i = 0, j = _r.length; i &lt; j; i++ )
                _optls.push( &#x27;&lt;option value=&quot;&#x27;+_r[i][0]+&#x27;&quot;&gt;&#x27;+ _r[i][1] +&#x27;&lt;/option&gt;&#x27; );

            $( _optls.join(&#x27;&#x27;) ).appendTo( _select );
            hasVal( _select, _selectval ) ? _select.val( _selectval ) : selectFirst( _select );
            _callback &amp;&amp; _callback( _select );
        });
    }//end getData
    /**
     * 判断下拉框是否为空
     * &lt;br /&gt;带 defaultoption 属性的 option 判断时被忽略
     * @method  initAutoSelect.isEmpty
     * @private
     * @static
     * @param   {selector}  _select
     */
    function isEmpty( _select ){
        var _r = true;
        _select.find(&#x27;option&#x27;).each( function(){
            var _tmp = $(this);
            if( !_tmp.is( &#x27;[defaultoption]&#x27; ) ){
                return _r = false;
            }
        });
        return _r;
    }
    /**
     * 选中下拉框的第一个option
     * @method  initAutoSelect.selectFirst
     * @private
     * @static  
     * @param   {selector}  _select
     */
    function selectFirst( _select ){
        var _ls = _select.find(&#x27;option&#x27;);
        if( _ls.length ){
            _select.val( _ls.first().val() );
        }
    }
    /**
     * 清空下拉框的内容
     * &lt;br /&gt;带 defaultoption 属性的 option 判断时被忽略
     * @method  initAutoSelect.removeOption
     * @private
     * @static
     * @param   {selector}  _select
     */
    function removeOption( _select ){
        var _ls = _select.find(&#x27;option&#x27;);
        for( var i = _ls.length - 1; i &gt;= 0; i-- ){
            var _item = $(_ls[i]);
            if( _item.is( &#x27;[defaultoption]&#x27; ) ) continue;
            _item.remove();
        }
    }
    /**
     * 判断下拉框的option里是否有给定的值
     * @method  initAutoSelect.hasVal
     * @private
     * @static
     * @param   {selector}  _select
     * @param   {string}    _val    要查找的值
     */
    function hasVal( _select, _val ){
        var _r = false, _val = _val.toString();
        _select.find(&#x27;option&#x27;).each( function(){
            var _tmp = $(this);
            if( _tmp.val() == _val ){
                _r = true;
                return false;
            }
        });
        return _r;
    }
    /**
     * 判断下拉框是否有数据项
     * &lt;br /&gt;带 defaultoption 属性的 option 判断时被忽略
     * @method  initAutoSelect.hasItem
     * @private
     * @static
     * @param   {selector}  _select
     */
    function hasItem( _select ){
        var _r = false;
        _select.find(&#x27;option&#x27;).each( function(){
            var _tmp = $(this);
            if( _tmp.is( &#x27;[defaultoption]&#x27; ) ) return;
            _r = true;
            return false;
        });
        return _r;
    }
    /**
     * 取得某一类级联下拉框的所有下拉框
     * @method  initAutoSelect.getSelectList
     * @private
     * @static
     * @param   {selector}  _select     调用时, _select 为起始下拉框, 带 defaultselect 属性
     * @param   {array}     _ar         返回结果, 该参数不需要显示赋予
     */
    function getSelectList( _select, _ar ){
        _select = $(_select);
        if( !_ar ){
            _ar =[ _select ];
            arguments.callee( _select, _ar );
        }else if( _select.length &amp;&amp; _select.is( &#x27;[selecttarget]&#x27; ) ){
            var _target = $(_select.attr(&#x27;selecttarget&#x27;));
            if( _target.length ){
                _target.data( &#x27;parentSelect&#x27;, _ar[ _ar.length - 1 ] );
                _ar.push( _target );
                arguments.callee( _target, _ar );
            }
        }
        return _ar;
    }
}(jQuery));


    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
