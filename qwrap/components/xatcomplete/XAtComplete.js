void function(){window.CUR_XATCOMPLETE=window.CUR_XATCOMPLETE||null;var s={start:0,end:0};var y=/IE 6/i.test(navigator.userAgent);var A=/IE 7/i.test(navigator.userAgent);function C(a){this.model=new B(a).init();this.view=new D(this.model).init()}C.exec=function(a){return new C(a).init()};C.update=function(b,a){if(!window.CUR_XATCOMPLETE){return}window.CUR_XATCOMPLETE.view.update(b,a)};C.reset=function(a){w(a)};C.prototype={init:function(){q();var a=this;if(!a.model.trigger){return this}attach_event_f(a.model.trigger,"focus",function(){window.CUR_XATCOMPLETE=a});attach_event_f(a.model.trigger,"click",function(b){a.view.hide();if(a.model.isSameCursor()){return}stopPropagation(b);a.view.show(0)});attach_event_f(a.model.trigger,"keypress",function(c){c=c||window.event;var b=keycode_f(c);if(b.keyCode===13){if(a.view.isShow()){preventDefault(c);a.view.updateTrigger()}a.view.hide()}if(b.keyCode===32){a.view.hide()}});attach_event_f(a.model.trigger,"keydown",function(c){c=c||window.event;var b=keycode_f(c);if(b.keyCode===27){preventDefault(c);stopPropagation(c);a.view.hide();return}if(a.view.isShow()){switch(b.keyCode){case 38:preventDefault(c);a.view.selectPrevPopupItem();return;case 40:preventDefault(c);a.view.selectNextPopupItem();return}}});attach_event_f(a.model.trigger,"keyup",function(f){f=f||window.event;var e=keycode_f(f);var b=a.model.cursorChar();switch(e.keyCode){case 37:case 39:case 38:case 40:case 8:if(e.keyCode===38||e.keyCode===40){if(a.view.isShow()){return}}var c=a.model.getCursorPosistion();var d=a.model.getRightPopupPosition();if(c!==d){if(d>=0){a.view.show()}}else{a.view.hide()}return}if(/[　]/.test(b)){a.view.hide();return}if(/[@＠]/.test(b)){if(a.model.isInQuery()){preventDefault(f)}a.view.show();return}if(a.view.isShow()&&a.model.isInQuery()){a.view.show()}});return this}};function B(b){this.trigger;this.popup;this.data_url;this.queryKey;this.debug;this.encodeFunc=encodeURIComponent;this.decodeFunc=decodeURIComponent;for(var a in b){this[a]=b[a]}}B.prototype={init:function(){this.trigger=getId(this.trigger);this.queryKey=this.queryKey||"query";if(this.popup){this.popup=getId(this.popup);if(!this.popup){this.popup=r()}}else{this.popup=r()}return this},getCursorPosistion:function(){return get_cursor(this.trigger)},popupItems:function(){var a=[];if(this.popup){a=this.popup.getElementsByTagName("li")}return a},selectedPopupItem:function(){var a=null;if(this.popup){var c=this.popupItems();if(c.length){for(var b=0;b<c.length;b++){if(HasClass(c[b],"on")){a={item:c[b],index:b};break}}}}return a},getRightPopupPosition:function(){var a=this.getCursorPosistion();var b=a;var c=this.trigger.value;while(a>0){if(/[\r\n 　]/.test(c.slice(a-1,a))){break}else{if(/[@＠]/.test(c.slice(a-1,a))){b=a-1;break}}a--}if(b<0){b=0}return b},isInQuery:function(){var a=false;var b=this.trigger.value;var c=this.getCursorPosistion();while(c>0){if(/[\r\n 　]/.test(b.slice(c-1,c))){break}else{if(/[@＠]/.test(b.slice(c-1,c))){a=true;break}}c--}return a},getQueryString:function(){var c=[];var d=this.trigger.value;var b=this.getCursorPosistion();var f=this.getRightPopupPosition();if(d.slice(f,f+1)=="@"||d.slice(f,f+1)=="＠"){f++}for(var e=f;e<d.length;e++){if(e>=b){break}var a=d.slice(e,e+1);if(!/[\r\n 　@＠]/m.test(a)){c.push(a)}else{break}}return c.join("")},queryData:function(a){var b=this.data_url;b=add_url_param(b,{key:this.queryKey,value:this.encodeFunc(a)});b=add_url_param(b,{key:"rnd",value:Math.random()});XAppendScript(b,p())},isSameCursor:function(){return this.getCursorPosistion()===this.getRightPopupPosition()},cursorChar:function(){var a=this.getCursorPosistion();var b="";if(this.trigger.value.length&&a>0){b=this.trigger.value.slice(a-1,a)}return b}};function D(a){this.model=a}D.prototype={init:function(){return this},hide:function(){var a=this;a.model.popup.style.display="none"},show:function(c){c=c||0;var a=this;var g=x();var d=ele_pos_f(a.model.trigger);g.style.left=d.left+"px";g.style.top=d.top+"px";g.style.width=d.width+"px";g.style.height=d.height+"px";s.start=a.model.getRightPopupPosition();s.end=a.model.getCursorPosistion()+c;var f=a.model.trigger.value.slice(0,s.start);x(f.replace(/[ ]/g,"a"),a);var e=a.model.getQueryString();var b=u(e);if(typeof b!=="boolean"){a.update(b,e)}else{a.model.queryData(e)}var h=g.getElementsByTagName("span");if(h.length){var i=ele_pos_f(h[0]);if(y||A){i.top+=4}a.model.popup.style.left=i.left+"px";a.model.popup.style.top=i.top+13-a.model.trigger.scrollTop+"px"}a.model.popup.style.zIndex=getMaxIndex();a.model.popup.style.display="block";v(f,this);a.initItemsEvent()},isShow:function(){return this.model.popup.style.display!="none"},initItemsEvent:function(){var a=this;var e=a.model.popupItems();for(var c=0;c<e.length;c++){var b=e[c];if(!b.getAttribute("isset")){b.setAttribute("isset",1)}else{continue}var f=b.getElementsByTagName("a");if(f.length){for(var d=0;d<f.length;d++){attach_event_f(f[c],"click",function(g){preventDefault(g)})}}attach_event_f(b,"mouseover",function(g){a.setCurrentItem(this)});attach_event_f(b,"click",function(g){a.updateTrigger();a.hide()})}},setCurrentItem:function(c){if(HasClass(c,"sloading")){return}var a=this;var d=a.model.popupItems();for(var b=0;b<d.length;b++){KillClass(d[b],"on")}AddClass(c,"on")},selectedItemData:function(){var b=null;var a=this.model.selectedPopupItem();if(a&&a.item){b={text:a.item.getAttribute("title")||a.item.innerHTML,obj:a}}return b},selectPrevPopupItem:function(){var d=this.model.popupItems();var c=null;if(d.length){var a=0;var b=this.model.selectedPopupItem();if(b){a=b.index-1}if(a<0){a=d.length-1}c=d[a];this.setCurrentItem(c)}return c},selectNextPopupItem:function(){var d=this.model.popupItems();var c=null;if(d.length){var a=0;var b=this.model.selectedPopupItem();if(b){a=b.index+1}if(a>=d.length){a=0}c=d[a];this.setCurrentItem(c)}return c},updateTrigger:function(){var e=this;var h=this.selectedItemData();if(!h){return}var a=s.end;var b=s.start+1;var c=this.model.trigger.value;var f=c.slice(0,b);var d=c.slice(a);f=f.replace(/[＠@]$/,"@");var g="";if(d.length){if(!/[ 　]/.test(d.slice(0,1))){g=" "}}else{g=" "}var c=f+h.text+g+d;this.model.trigger.value=c;curPos=b+h.text.length+1;set_cursor(e.model.trigger,curPos);v(["before: "+f,"text: "+h.text+g,"after: "+d,"selPos: "+a,"pos: "+b].join("\n\n"),this)},update:function(f,c){var d=this.model.popup.getElementsByTagName("ul");if(!d.length){return}d=d[0];if(typeof c!="undefined"){t(this.model.decodeFunc(c),f)}if(!(f&&f.length)){d.innerHTML='<li class="sloading" isset="1">没有相关数据</li>';return}var b=[];var g=25;for(var e=0;e<f.length;e++){var a=f[e];if(a.length>g){a=a.slice(0,g)}var h="";if(e===0){h=' class="on" '}b.push('<li title="'+f[e]+'"'+h+">"+a+"</li>")}d.innerHTML=b.join("");this.initItemsEvent()}};function q(){if(window.XATCOMPLETE_INIT_LOCK){return}window.XATCOMPLETE_INIT_LOCK=true;attach_event_f(window,"keyup",function(b){if(!window.CUR_XATCOMPLETE){return}var a=keycode_f(b);if(a.keyCode===27){window.CUR_XATCOMPLETE.view.hide()}});attach_event_f(window,"click",function(){if(!window.CUR_XATCOMPLETE){return}window.CUR_XATCOMPLETE.view.hide()});attach_event_f(window,"resize",function(){if(!window.CUR_XATCOMPLETE){return}if(window.CUR_XATCOMPLETE.view.isShow()){window.CUR_XATCOMPLETE.view.show()}});attach_event_f(window,"scroll",function(){if(!window.CUR_XATCOMPLETE){return}if(window.CUR_XATCOMPLETE.view.isShow()){window.CUR_XATCOMPLETE.view.show()}});w()}function w(a){window.XAT_CACHE={};if(window.XAT_RESET_TO){try{clearTimeout(window.XAT_RESET_TO)}catch(b){}}window.XAT_RESET_TO=setTimeout(function(){w(a)},a||1000*60*5)}function u(a){window.XAT_CACHE=window.XAT_CACHE||{};var b=false;if(a in window.XAT_CACHE){b=window.XAT_CACHE[a]}return b}function t(a,b){window.XAT_CACHE=window.XAT_CACHE||{};if(typeof a==="undefined"){return}window.XAT_CACHE[a]=b}function p(){var a=window.XATCOMPLETE_DATA_BOX;if(!a){a=document.createElement("div");a.style.display="none";a.setAttribute("for_read","XATCOMPLETE_DATA_BOX");window.XATCOMPLETE_DATA_BOX=a;document.body.appendChild(a)}a.innerHTML="";return a}function x(c,d){var b=window.XATCOMPLETE_MASK_BOX;if(!b){b=document.createElement("div");b.className="xat_mask";b.setAttribute("for_read","XATCOMPLETE_MASK_BOX");window.XATCOMPLETE_MASK_BOX=b;document.body.appendChild(b)}if(d){z(d.model.trigger,b)}if(typeof c!="undefined"){var a=c||"";a=a.replace(/\r\n/g,"<br />");a=a.replace(/\r/g,"<br />");a=a.replace(/\n/g,"<br />");b.innerHTML=a+'<span class="mark">x</span>'}return b}function r(b){var a=window.XATCOMPLETE_POPUP_BOX;if(!a){a=document.createElement("dl");a.className="xat_box";a.setAttribute("for_read","XATCOMPLETE_POPUP_BOX");window.XATCOMPLETE_POPUP_BOX=a;a.style.display="none";a.innerHTML=["    <dt>选择昵称或轻敲空格完成输入</dt>\n","    <dd>\n",'        <ul class="slist">\n','            <li class="sloading" isset="1">数据加载中, 请稍候...</li>',"        </ul>\n","    </dd>\n"].join("");document.body.appendChild(a)}if(typeof b!="undefined"&&typeof b=="string"){a.innerHTML=b}return a}function v(a,b){if(!b.model.debug){return}var c=document.getElementById("xat_debug_");if(!c){c=document.createElement("textarea");c.id="xat_debug_";document.body.appendChild(c)}c.disabled=true;if(b){z(b.model.trigger,c)}c.style.width=b.model.trigger.offsetWidth+"px";c.style.height=b.model.trigger.offsetHeight+"px";c.value=a}function z(b,a){a.style.paddingTop=style_f(b,"paddingTop")||0;a.style.paddingRight=style_f(b,"paddingRight")||0;a.style.paddingBottom=style_f(b,"paddingBottom")||0;a.style.paddingLeft=style_f(b,"paddingLeft")||0}window.XAtComplete=C}();