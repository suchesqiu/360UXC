Suggest=function(a){Suggest._argValid(a,"object",arguments.callee);this._config={autoFocusFirstItem:true,autoSelectToEnter:false,cacheCapacity:-1,cacheAutoScale:true,data:null,dataUrl:"",dataType:"ScriptCallBack",dataCallback:Suggest.O,dataHandler:function(d,e,c){if(e.sug){for(var b=0;b<e.sug.length;b++){e.sug[b].key=e.sug[b].display=e.sug[b].q;e.sug[b].val=" "}c._read(e.sug);c._prop.cache.pushCache(d,e.sug)}else{c._read([]);c._prop.cache.pushCache(d,[])}},dataCapacity:10,ui:null,textbox:"",uiTemplate:'<div><span class="key">{display}</span><span class="val">{val}</span></div>',uiRender:Suggest.O,uiHighlighter:Suggest.O,uiBaseLayerConfig:{autoPosition:false},uiItemNumber:-1,uiContainer:null,uiStyle:{itemClass:"item",containerClass:"panel-suggest",selectClass:"selected",focusClass:"selected"},uiView:null,uiSelectFilter:function(b){return true}};this._prop={index:-1,isShown:false,data:null,ui:null};this._filter={};QW.ObjectH.mix(this._config,a,true);this._init()};Suggest._EVENT=["backspace","input","enter","esc","focus","blur","itemfocus","itemblur","itemselect"];Suggest.prototype={_dispatch:function(c){if(!QW.ArrayH.contains(Suggest._EVENT,c)){Suggest._debug("arg",'event type "'+c.toString()+'" not exist when dispatching',arguments.callee);return false}var b=this.getItem(this._prop.index);var a=new QW.CustEvent(b,c);a.suggest=b;this.fire(a)},_init:function(){if(!this._initData()){Suggest._debug("arg","init data error",this);return false}if(!this._initUI()){Suggest._debug("arg","init ui error",this);return false}if(!this._initEvent()){Suggest._debug("arg","init event error",this);return false}},_initData:function(){if(null===this.get("data")){var a=new Suggest.Data(this._config);this._prop.data=this.set("data",a)}else{this._prop.data=this.get("data")}return true},_initUI:function(){if(null===this.get("ui")){var a=new Suggest.UI(this._config);this._prop.ui=this.set("ui",a)}else{this._prop.ui=this.get("ui")}return true},_initEvent:function(){QW.CustEvent.createEvents(this,Suggest._EVENT);var c=this._prop.ui;var a=this;var b=this._prop.data;c.on("up",function(){if(a.isShown()){a.previous()}});c.on("down",function(){if(a.isShown()){a.next()}else{a.suggest(this.getTextboxValue())}});c.on("change",function(d){a.suggest(this.getTextboxValue());a._dispatch("input")});c.on("esc",function(){if(a.isShown()){a.hide()}});c.on("backspace",function(){a._dispatch("backspace")});c.on("enter",function(){var d=a._prop.index;if(d>=0){c.setKeyword(b.getItem(a._prop.index).key);c.setTextboxValue(b.getItem(a._prop.index).key)}a.hide();a._dispatch("enter")});c.on("blur",function(){a._dispatch("blur")});c.on("focus",function(){a.suggest(this.getTextboxValue());a._dispatch("focus")});c.on("itemblur",function(d){a.blur(d.itemIndex)});c.on("itemfocus",function(d){a.focus(d.itemIndex)});c.on("itemselect",function(d){a.select(d.itemIndex)});b.on("datachange",function(){if(b.getLength()>0){a.show();c.render(this.getData());if(a.isShown()&&a.get("autoFocusFirstItem")){a._prop.index=0;while(!a.get("uiSelectFilter")(a.getItem(a._prop.index).data)){a._prop.index++}a.focus(a._prop.index)}}else{a.hide()}});b.on("indexchange",function(){if(b.getLength()<=0){return}var d=this.getIndex();if(d>=0){c.setTextboxValue(b.getItem(this.getIndex()).key)}else{c.setTextboxValue(c.getKeyword())}});return true},set:function(b,a){this._config[b]=a;return a},get:function(a){return this._config[a]},setFilter:function(b,a){this._filter[b]=a;return a},getData:function(){return this._prop.data},getKeyword:function(){return this._prop.ui.getKeyword()},setKeyword:function(a){return this._prop.ui.setTextboxValue(a)},getItem:function(a){return{index:a,data:this._prop.data.getItem(a),ui:this._prop.ui.getItem(a)}},isShown:function(){return this._prop.isShown},show:function(){var a=true;if(!this.isShown()){a=this._prop.ui.show();this._prop.isShown=a}return a},hide:function(){var a=false;if(this.isShown()){a=this._prop.ui.hide();this._prop.isShown=!a}this._prop.index=-1;this._prop.data.setCurrent(-1);return a},suggest:function(a){this.set("keyword",a);if(a!=""){var b=this;this._prop.data.query(a)}return true},select:function(a){if(!Suggest._argValid(a,"number",arguments.callee)){return false}this._prop.index=a;this._prop.ui.setKeyword(this._prop.data.getItem(a).key);this._prop.data.setCurrent(a);this._dispatch("itemselect");if(this.get("autoSelectToEnter")){this._dispatch("enter")}this.hide();return true},focus:function(a){if(this._prop.index!=-1){this.blur(this._prop.index)}if(!Suggest._argValid(a,"number",arguments.callee)){return false}this._prop.index=a;this._prop.ui.focusItem(a);this._dispatch("itemfocus");return true},blur:function(a){if(!Suggest._argValid(a,"number",arguments.callee)){return false}if(this._prop.index!=-1){this._prop.ui.blurItem(this._prop.index)}this._dispatch("itemblur");this._prop.index=-1;this._prop.ui.blurItem(a);return true},exchange:function(a,b){if(!Suggest._argValid(a,"number",arguments.callee)||!Suggest._argValid(b,"number",arguments.callee)){return false}return this.blur(a)&&this.focus(b)},previous:function(){this.show();var a=this._prop.index;this._prop.index=a>0?a-1:this._prop.data.getLength()-1;this._prop.data.setCurrent(this._prop.index);this.exchange(a,this._prop.index);if(!this.get("uiSelectFilter")(this.getItem(this._prop.index).data)){this.previous()}},next:function(){this.show();var b=this._prop.index;if(b<this._prop.data.getLength()-1){this._prop.data.setCurrent(b+1);this.exchange(b,b+1)}else{var a=this;if(this._prop.data.get("capacity")==-1||this._prop.data.get("capacity")>this._prop.data.getLength()){this._prop.data.increase(this._prop.data.getLength(),function(){a._prop.data.setCurrent(b+1);a.exchange(b,b+1)})}else{this.exchange(b,-1);this._prop.index=-1;this._prop.data.setCurrent(-1)}}if(this._prop.index!=-1&&!this.get("uiSelectFilter")(this.getItem(this._prop.index).data)){this.next()}}};Suggest._debug=function(d,a,c){var b="";switch(d){case"arg":b="参数错误";break;case"ret":b="返回错误";break;case"net":b="网络异常";break;default:break}};Suggest._argValid=function(a,c,b){if(typeof a!=c){Suggest._debug("arg","The type of "+a==window.undefined?a.toString():"null is not "+c+", please check again",b);return false}return true};Suggest.O=function(){};QW.provide("Suggest",Suggest);