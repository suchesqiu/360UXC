Suggest=function(b){Suggest._argValid(b,"object",arguments.callee);this._config={autoFocusFirstItem:true,autoSelectToEnter:false,cacheCapacity:-1,cacheAutoScale:true,data:null,dataUrl:"",dataType:"ScriptCallBack",dataCallback:Suggest.O,dataHandler:function(g,f,h){if(f.sug){for(var a=0;a<f.sug.length;a++){f.sug[a].key=f.sug[a].display=f.sug[a].q;f.sug[a].val=" "}h._read(f.sug);h._prop.cache.pushCache(g,f.sug)}else{h._read([]);h._prop.cache.pushCache(g,[])}},dataCapacity:10,ui:null,textbox:"",uiTemplate:'<div><span class="key">{display}</span><span class="val">{val}</span></div>',uiRender:Suggest.O,uiHighlighter:Suggest.O,uiBaseLayerConfig:{autoPosition:false},uiItemNumber:-1,uiContainer:null,uiStyle:{itemClass:"item",containerClass:"panel-suggest",selectClass:"selected",focusClass:"selected"},uiView:null,uiSelectFilter:function(a){return true}};this._prop={index:-1,isShown:false,data:null,ui:null};this._filter={};QW.ObjectH.mix(this._config,b,true);this._init()};Suggest._EVENT=["backspace","input","enter","esc","focus","blur","itemfocus","itemblur","itemselect"];Suggest.prototype={_dispatch:function(f){if(!QW.ArrayH.contains(Suggest._EVENT,f)){Suggest._debug("arg",'event type "'+f.toString()+'" not exist when dispatching',arguments.callee);return false}var d=this.getItem(this._prop.index);var e=new QW.CustEvent(d,f);e.suggest=d;this.fire(e)},_init:function(){if(!this._initData()){Suggest._debug("arg","init data error",this);return false}if(!this._initUI()){Suggest._debug("arg","init ui error",this);return false}if(!this._initEvent()){Suggest._debug("arg","init event error",this);return false}},_initData:function(){if(null===this.get("data")){var b=new Suggest.Data(this._config);this._prop.data=this.set("data",b)}else{this._prop.data=this.get("data")}return true},_initUI:function(){if(null===this.get("ui")){var b=new Suggest.UI(this._config);this._prop.ui=this.set("ui",b)}else{this._prop.ui=this.get("ui")}return true},_initEvent:function(){QW.CustEvent.createEvents(this,Suggest._EVENT);var f=this._prop.ui;var e=this;var d=this._prop.data;f.on("up",function(){if(e.isShown()){e.previous()}});f.on("down",function(){if(e.isShown()){e.next()}else{e.suggest(this.getTextboxValue())}});f.on("change",function(a){e.suggest(this.getTextboxValue());e._dispatch("input")});f.on("esc",function(){if(e.isShown()){e.hide()}});f.on("backspace",function(){e._dispatch("backspace")});f.on("enter",function(){var a=e._prop.index;if(a>=0){f.setKeyword(d.getItem(e._prop.index).key);f.setTextboxValue(d.getItem(e._prop.index).key)}e.hide();e._dispatch("enter")});f.on("blur",function(a){e._dispatch("blur")});f.on("focus",function(){e.suggest(this.getTextboxValue());e._dispatch("focus")});f.on("itemblur",function(a){e.blur(a.itemIndex)});f.on("itemfocus",function(a){e.focus(a.itemIndex)});f.on("itemselect",function(a){e.select(a.itemIndex)});d.on("datachange",function(){if(d.getLength()>0){e.show();f.render(this.getData());if(e.isShown()&&e.get("autoFocusFirstItem")){e._prop.index=0;while(!e.get("uiSelectFilter")(e.getItem(e._prop.index).data)){e._prop.index++}e.focus(e._prop.index)}}else{e.hide()}});d.on("indexchange",function(){if(d.getLength()<=0){return}var a=this.getIndex();if(a>=0){f.setTextboxValue(d.getItem(this.getIndex()).key)}else{f.setTextboxValue(f.getKeyword())}});return true},set:function(c,d){this._config[c]=d;return d},get:function(b){return this._config[b]},setFilter:function(c,d){this._filter[c]=d;return d},getData:function(){return this._prop.data},getKeyword:function(){return this._prop.ui.getKeyword()},setKeyword:function(b){return this._prop.ui.setTextboxValue(b)},getItem:function(b){return{index:b,data:this._prop.data.getItem(b),ui:this._prop.ui.getItem(b)}},isShown:function(){return this._prop.isShown},show:function(){var b=true;if(!this.isShown()){b=this._prop.ui.show();this._prop.isShown=b}return b},hide:function(){var b=false;if(this.isShown()){b=this._prop.ui.hide();this._prop.isShown=!b}this._prop.index=-1;this._prop.data.setCurrent(-1);return b},suggest:function(d){this.set("keyword",d);if(d!=""){var c=this;this._prop.data.query(d)}return true},select:function(b){if(!Suggest._argValid(b,"number",arguments.callee)){return false}this._prop.index=b;this._prop.ui.setKeyword(this._prop.data.getItem(b).key);this._prop.data.setCurrent(b);this._dispatch("itemselect");if(this.get("autoSelectToEnter")){this._dispatch("enter")}this.hide();return true},focus:function(b){if(this._prop.index!=-1){this.blur(this._prop.index)}if(!Suggest._argValid(b,"number",arguments.callee)){return false}this._prop.index=b;this._prop.ui.focusItem(b);this._dispatch("itemfocus");return true},blur:function(b){if(!Suggest._argValid(b,"number",arguments.callee)){return false}if(this._prop.index!=-1){this._prop.ui.blurItem(this._prop.index)}this._dispatch("itemblur");this._prop.index=-1;this._prop.ui.blurItem(b);return true},exchange:function(d,c){if(!Suggest._argValid(d,"number",arguments.callee)||!Suggest._argValid(c,"number",arguments.callee)){return false}return this.blur(d)&&this.focus(c)},previous:function(){this.show();var b=this._prop.index;this._prop.index=b>0?b-1:this._prop.data.getLength()-1;this._prop.data.setCurrent(this._prop.index);this.exchange(b,this._prop.index);if(!this.get("uiSelectFilter")(this.getItem(this._prop.index).data)){this.previous()}},next:function(){this.show();var c=this._prop.index;if(c<this._prop.data.getLength()-1){this._prop.data.setCurrent(c+1);this.exchange(c,c+1)}else{var d=this;if(this._prop.data.get("capacity")==-1||this._prop.data.get("capacity")>this._prop.data.getLength()){this._prop.data.increase(this._prop.data.getLength(),function(){d._prop.data.setCurrent(c+1);d.exchange(c,c+1)})}else{this.exchange(c,-1);this._prop.index=-1;this._prop.data.setCurrent(-1)}}if(this._prop.index!=-1&&!this.get("uiSelectFilter")(this.getItem(this._prop.index).data)){this.next()}}};Suggest._debug=function(g,f,h){var e="";switch(g){case"arg":e="参数错误";break;case"ret":e="返回错误";break;case"net":e="网络异常";break;default:break}};Suggest._argValid=function(e,f,d){if(typeof e!=f){Suggest._debug("arg","The type of "+e==window.undefined?e.toString():"null is not "+f+", please check again",d);return false}return true};Suggest.O=function(){};QW.provide("Suggest",Suggest);Suggest.Cache=function(b){Suggest._argValid(b,"object",arguments.callee);this._config={cacheCapacity:-1,cacheAutoScale:true};this._prop={cache:[]};QW.ObjectH.mix(this._config,b,true);return this._init()};Suggest.Cache.prototype={_init:function(){return true},set:function(c,d){this._config[c]=d;return d},get:function(b){return this._config[b]},getCache:function(b){if(!Suggest._argValid(b,"string",arguments.callee)){return false}if(this._prop.cache[b]){return this._prop.cache[b]}else{return null}},pushCache:function(g,f){if(!Suggest._argValid(g,"string",arguments.callee)){return false}var h=this.get("cacheAutoScale"),e=this.get("cacheCapacity");if(!h&&e!=-1&&this._prop.cache.length>=e){Suggest._debug("overflow","Can not push data into cache because of overflow",arguments.callee);return false}if(h&&e!=-1&&this._prop.cache.length>=e){this._prop.cache.shift()}this._prop.cache[g]=f;return f},hasCache:function(b){return this._prop.cache[b]!=window.undefined?true:false},empty:function(){try{this._prop.cache.length=0;return true}catch(b){return false}},getLength:function(){return this._prop.cache.length}};Suggest.Data=function(b){Suggest._argValid(b,"object",arguments.callee);this._config={dataUrl:null,dataType:"ScriptCallBack",dataCallBack:Suggest.O,dataHandler:Suggest.O,dataCapacity:-1,callback:"callback",keyword:"keyword"};this._prop={key:"",index:-1,originalIndex:-1,cache:null,data:[]};QW.ObjectH.mix(this._config,b,true);return this._init()};Suggest.Data._EVENT=["datachange","indexchange","overflow"];Suggest.Data._UID={};Suggest.Data.prototype={_init:function(){var d=this.get("dataType");if(this.get("dataUrl")!=""){if(d=="ScriptCallBack"){var c=this.get("dataUrl")+"&max_count="+this.get("dataCapacity");this.set("dataUrl",c)}if(d=="ScriptData"){}}return this._initCache()&&this._initEvent()},_initCache:function(){var b=new Suggest.Cache(this._config);if(!b){Suggest._debug("arg","cacheCapacity",arguments.callee);return false}this._prop.cache=this.set("cache",b);return true},_initEvent:function(){return QW.CustEvent.createEvents(this,Suggest.Data._EVENT)},_dispatch:function(c){if(!QW.ArrayH.contains(Suggest.Data._EVENT,c)){Suggest._debug("arg",'event type "'+c.toString()+'" not exist',this);return false}var d=new QW.CustEvent(this,c);d.suggestData=this;this.fire(d)},query:function(d,c){if(!Suggest._argValid(d,"string",arguments.callee)){return false}this._prop.key=d;if(this._prop.cache.hasCache(d)){this._read(this._prop.cache.getCache(d));if(c){c.apply(this)}return true}else{return this._request(this.get("dataCallback"))}},_request:function(h){var i=0;do{i=(Math.random()*100000000).toFixed(0)}while(Suggest.Data._UID[i]!==window.undefined);Suggest.Data._UID[i]="";if(this.get("dataType")=="ScriptCallBack"){var j=document.getElementsByTagName("head")[0];var f=document.createElement("script");var g=false;f.src=this.get("dataUrl")+"&"+this._config.keyword+"="+window.encodeURIComponent(QW.StringH.trim(this._prop.key))+"&"+this._config.callback+"=_SuggestCallBack"+i;window["_SuggestCallBack"+i]=this._scriptCallbackHandler(this._prop.key);if(Suggest._argValid(h,"function",arguments.callee)){f.onload=f.onreadystatechange=function(){if(!g&&(!this.readyState||this.readyState=="loaded"||this.readyState=="complete")){g=true;h()}}}j.appendChild(f);return true}},_scriptCallbackHandler:function(f){var e=this;var d=this.get("dataHandler");return function(a){d(f,a,e)}},_read:function(b){if(b.length!==undefined){this._prop.data=b;this._dispatch("datachange");return true}else{Suggest._debug("arg","aDataSource must be an array",b);return false}},set:function(c,d){this._config[c]=d;return d},get:function(b){return this._config[b]},setCurrent:function(b){if(!Suggest._argValid(b,"number",arguments.callee)){return false}if(b>this.getLength()){Suggest._debug("arg","index setted is larger than the length of data",arguments.callee);return false}this._prop.originalIndex=this._prop.index;this._prop.index=b;this._dispatch("indexchange");return true},getData:function(){return this._prop.data},getOriginalIndex:function(){return this._prop.originalIndex},getIndex:function(){return this._prop.index},getItem:function(b){if(!Suggest._argValid(b,"number",arguments.callee)){return false}if(b>this.getLength()-1){return false}return this._prop.data[b]},getLength:function(){return this._prop.data.length},increase:function(d,f){var e=this.get("dataUrl");e.replace(/&max_count=([^&]*)/gi,function(a,b){return"&max_count="+(parseInt(b,10)+d)});return this._request(f)}};Suggest.UI=function(b){Suggest._argValid(b,"object",arguments.callee);this._config={textbox:"",uiCaption:null,uiView:null,uiBaseLayerConfig:{autoPosition:false},uiContainer:null,uiReferEl:null,_interval:50};this._prop={_textChangeTimer:null,textbox:null,keyword:"",baseLayer:null,view:null,_isTimerOn:null};QW.ObjectH.mix(this._config,b,true);return this._init()};Suggest.UI._EVENT=["backspace","up","down","change","esc","enter","focus","blur","itemfocus","itemblur","itemselect"];Suggest.UI.prototype={_dispatch:function(f,e){if(!QW.ArrayH.contains(Suggest.UI._EVENT,f)){Suggest._debug("arg",'event type "'+f.toString()+'" not exist when dispatching Suggest.UI instance ',this);return false}if(e){this.fire(e)}else{var d=new QW.CustEvent(this,f);d.suggestUI=this;this.fire(d)}},_init:function(){return this._initTextbox()&&this._initView()&&this._initBaseLayer()&&this._initEvent()},_initTextbox:function(){var f=QW.NodeW(this.get("textbox")).core;f=f.length?f[0]:f;var e=QW.NodeW(f);this.set("textbox",e);this._prop.textbox=e;var d=this;e.setAttr("autocomplete","off").on("keydown",function(a){d._keyEventHandler(a)}).on("focus",function(a){d._dispatch("focus");d._addTextChangeTimer()}).on("blur",function(a){d._dispatch("blur");d._removeTextChangeTimer()});return true},_initView:function(){var c=this.get("uiView");if(c===null){c=new Suggest.UI.ListView(this._config)}this.set("uiView",c);this._prop.view=c;var d=this;c.on("itemfocus",function(a){d._dispatch("itemfocus",a)});c.on("itemblur",function(a){d._dispatch("itemblur",a)});c.on("itemselect",function(a){d._removeTextChangeTimer();d._dispatch("itemselect",a)});return true},_initBaseLayer:function(){var e=this.get("uiBaseLayerConfig");if(this.get("uiContainer")&&QW.DomU.isElement(this.get("uiContainer"))){this._prop.baselayer=new QW.LayerPopup(this.get("uiContainer"),e)}else{e.INNER_CLASS="panel-content "+this.get("uiStyle").containerClass;this._prop.baselayer=new QW.LayerPopup(e)}if(this.get("uiCaption")!==null&&this.get("uiCaption")!==""){this._prop.baselayer.setCaption(this.get("uiCaption"))}this._prop.baselayer.setContent(QW.NodeH.g(this._prop.view.getContainer()));if(this.get("uiReferEl")!==null){var d=QW.NodeW(this.get("uiReferEl")).core;d=d.length?d[0]:d;var f=QW.NodeW(d);this.set("uiReferEl",f)}else{this.set("uiReferEl",this.get("textbox"))}return true},_initEvent:function(){QW.CustEvent.createEvents(this,Suggest.UI._EVENT);return true},_hasTextChangeTimer:function(){return this._prop._isTimerOn},_removeTextChangeTimer:function(){if(this._prop._isTimerOn){clearInterval(this._prop._textChangeTimer);this._prop._isTimerOn=false;return true}return true},_addTextChangeTimer:function(){if(!this._prop._isTimerOn){var b=this;b._prop._textChangeTimer=window.setInterval(function(){var a=b.getTextboxValue();if(b.getKeyword()!=a){b._prop.keyword=a;b._dispatch("change")}},b.get("_interval"));this._prop._isTimerOn=true;return true}return true},_keyManager:{DOWN:40,UP:38,ESC:27,ENTER:13,BACKSPACE:8,_invalidKeyCode:[40,39,38,37,27,13,17,16]},_isKeyValid:function(g){var e=this._keyManager._invalidKeyCode;for(var h=0,f=e.length;h<f;h++){if(e[h]==g){return false}}return true},_keyEventHandler:function(d){var c="";switch(d.keyCode){case this._keyManager.UP:c="up";d.preventDefault();this._removeTextChangeTimer();break;case this._keyManager.DOWN:c="down";this._removeTextChangeTimer();break;case this._keyManager.ESC:c="esc";this._removeTextChangeTimer();break;case this._keyManager.BACKSPACE:c="backspace";this._addTextChangeTimer();break;case this._keyManager.ENTER:c="enter";d.preventDefault();this._removeTextChangeTimer();break;default:if(this._isKeyValid(d.keyCode)){this._addTextChangeTimer()}}if(c!=""){this._dispatch(c)}},set:function(c,d){this._config[c]=d;return d},get:function(b){return this._config[b]},render:function(b){return this._prop.view.render(b)},setTextboxValue:function(b){this._prop.textbox.core.value=b;return true},getTextboxValue:function(){return QW.StringH.trim(this._prop.textbox.core.value)},show:function(){this._prop.baselayer.showPopup(null,this.get("uiReferEl").get("offsetHeight"),null,null,this.get("uiReferEl").core);return true},hide:function(){this._prop.baselayer.hide();return true},setKeyword:function(b){this._prop.keyword=b},getKeyword:function(){return QW.StringH.trim(this._prop.keyword)},getItem:function(b){return this._prop.view.getItem(b)},selectItem:function(b){this._prop.view.focusItem(b);return true},focusItem:function(b){this._prop.view.focusItem(b);return true},blurItem:function(b){this._prop.view.blurItem(b);return true}};Suggest.UI.ListView=function(b){Suggest._argValid(b,"object",arguments.callee);this._config={uiTemplate:"",uiListContainer:null,uiRender:null,uiHighlighter:Suggest.O,uiItemNumber:-1,uiStyle:{containerClass:"",selectClass:"",focusClass:""}};this._prop={container:null,items:[],start:0};QW.ObjectH.mix(this._config,b,true);return this._init()};Suggest.UI.ListView._EVENT=["itemfocus","itemblur","itemselect"];Suggest.UI.ListView.prototype={_init:function(){this._prop.container=this.get("uiListContainer")||QW.NodeW(document.createElement("div"));this._initEvent();return true},_initEvent:function(){QW.CustEvent.createEvents(this,Suggest.UI.ListView._EVENT);return true},_dispatch:function(f,e){if(!QW.ArrayH.contains(Suggest.UI.ListView._EVENT,f)){Suggest._debug("arg",'event type "'+f.toString()+'" not exist',this);return false}var d=new QW.CustEvent(this._prop.items[e],f);d.itemIndex=e;this.fire(d)},set:function(c,d){this._config[c]=d;return d},get:function(b){return this._config[b]},getContainer:function(){return this._prop.container},render:function(h){for(var g=0;g<this._prop.items.length;g++){this._prop.items[g].un()}this._prop.items.length=0;this._prop.start=0;this._prop.container.set("innerHTML","");for(var g=0,f=h.length;g<f;g++){this._prop.items[g]=this.renderItem(h[g],g);this.highlight(g);this._prop.container.appendChild(this._prop.items[g])}var e=this.get("uiItemNumber")==-1?this._prop.items.length:this.get("uiItemNumber");for(var g=e;g<this._prop.items.length;g++){this._prop.container.removeChild(this._prop.items[g])}},renderItem:function(i,h){var j=this.get("uiTemplate");var k=this.get("uiRender");var g=null;if(k!=QW.Suggest.O){g=QW.NodeW(k.apply(this,[i]))}else{if(j!=""){var l=j.replace(/\{([^\}]+)\}/gi,function(a,b){return i[b]||("{"+b+" }")});g=QW.NodeW(QW.DomU.create(l));g.addClass("item")}}this._bindEventToItem(g,h,i);return g},_bindEventToItem:function(e,f,g){var h=this;if(this.get("uiSelectFilter")(g)){e.on("mouseover",function(a){h._dispatch("itemfocus",f)});e.on("mouseout",function(a){h._dispatch("itemblur",f)});e.on("mousedown",function(a){h._dispatch("itemselect",f)})}else{e.on("mousedown",function(a){a.preventDefault()})}},scrollDown:function(){if(this._prop.start===0){return}this._prop.items[this._prop.start].insertSiblingBefore(this._prop.items[this._prop.start-1]);this._prop.container.removeChild(this._prop.items[this._prop.start+this.get("uiItemNumber")-1]);this._prop.start--},scrollUp:function(){this._prop.container.removeChild(this._prop.items[this._prop.start]);this._prop.items[this._prop.start+this.get("uiItemNumber")-1].insertSiblingAfter(this._prop.items[this._prop.start+this.get("uiItemNumber")]);this._prop.start++},scrollTo:function(b){while(b<this._prop.start||b>this._prop.start+this.get("uiItemNumber")-1){if(this._prop.start>b){this.scrollDown()}if(this._prop.start+this.get("uiItemNumber")-1<b){this.scrollUp()}}},getItem:function(b){return this._prop.items[b]},selectItem:function(b){this._prop.items[b].addClass(this.get("uiStyle").selectClass);return true},focusItem:function(b){b=parseInt(b,10);if(b<0){return false}this.scrollTo(b);this._prop.items[b].addClass(this.get("uiStyle").focusClass);return true},highlight:function(d){d=parseInt(d,10);if(d<0){return false}var c=this.get("uiHighlighter");c(this._prop.items[d],d);return true},blurItem:function(b){b=parseInt(b,10);if(b<0){return false}this._prop.items[b].removeClass(this.get("uiStyle").focusClass);return true}};