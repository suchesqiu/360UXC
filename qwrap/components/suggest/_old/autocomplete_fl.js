var SuggestLayer=function(){this.$super.apply(this,arguments);return this}.$extends(LayerPopup);SuggestLayer.prototype.autocompleteElements=[];SuggestLayer.prototype._addLayerPopupListener=function(){var d=this;var c=function(a){a=window.event||a;var b=BBEvent.target(a);if(!d._popup.contains(b)&&d.isVisible()){if(d.isVisible()){for(var e=0;e<d.autocompleteElements.length;e++){if(d.autocompleteElements[e]==b){return}}CustEvent.fireEvent(d,"blur",a);d.hide()}}};BBEvent.observe(document,"mousedown",c);BBEvent.observe(document,"keyup",c)};function AutocompleteCache(){this.cache={};return this}AutocompleteCache.prototype.read=function(b){if(this.cache[b]){return this.cache[b]}return null};AutocompleteCache.prototype.write=function(d,c){d=d+"";if(!this.read(d)){this.cache[d]=c}};var AutocompleteStyle={CONTAINER:"autocomplete",UNSELECTED_ENTRY:"unselectedentry",SELECTED_ENTRY:"selectedentry",UNSELECTED_KEY:"unselectedkey",UNSELECTED_VAL:"unselectedval",SELECTED_KEY:"selectedkey",SELECTED_VAL:"unselectedval"};var AutocompleteKeyMgr={DOWN:40,UP:38,ESC:27,ENTER:13,availableKeyCode:function(h){var g=[40,39,38,37,27,13,17,16];var f=g.length;for(var e=0;e<f;e++){if(g[e]==h){return false}}return true}};var AUTOCOMPLETE_EVENT={SHOW:"onshow",HIDE:"onhide",SELECT:"onselect",CHANGE:"onchange",INPUT:"oninput",ENTER:"onenter"};function getScript(j,h){var i=document.getElementsByTagName("head")[0];var f=document.createElement("script");var g=false;f.src=j;if(h){f.onload=f.onreadystatechange=function(){if(!g&&(!this.readyState||this.readyState=="loaded"||this.readyState=="complete")){g=true;h()}}}i.appendChild(f)}function AutocompleteDataMgr(b){this.tblPrefix="_table";this.tableId=this.tblPrefix+b.instanceName;this.instanceName=b.instanceName;this.multipleData=b.multipleData||true;this.classNames=b.classNames;this.dataSource=b.data||[];this._selectable=true;return this}AutocompleteDataMgr.prototype.getDataLength=function(){return this.dataSource.length};AutocompleteDataMgr.prototype.format=function(h){this.dataSource=h||this.dataSource;var g=this.dataSource.length;var e=[];e.push('<table onselectstart="return false" cellspacing="0" cellpadding="0" border="0" id="'+this.tableId+'" class="'+this.classNames.CONTAINER+'" width="100%">');for(var f=0;f<g;f++){e.push('<tr class="'+this.classNames.UNSELECTED_ENTRY+' " onmousedown="'+this.instanceName+".mousedownHandler(event, "+f+')" onclick="'+this.instanceName+".clickHandler("+f+')" onmouseover="'+this.instanceName+".overHandler("+f+')" onmouseout="'+this.instanceName+".outHandler("+f+')"><td class="'+this.classNames.UNSELECTED_KEY+'">'+(this.dataSource[f].display||this.dataSource[f].key)+"</td>"+(this.multipleData?'<td class="'+this.classNames.UNSELECTED_VAL+'" align="right">'+this.dataSource[f].val+"</td>":"")+"</tr>")}e.push("</table>");return e.join("")};AutocompleteDataMgr.prototype.gotoEntry=function(o,p){var r=this.classNames;var n=this.getKeyNode(o);var m=this.getValNode(o);var k=this.getKeyNode(p);var l=this.getValNode(p);var j=this.getEntryNode(o);var q=this.getEntryNode(p);Dom.replaceClassName(j,r.SELECTED_ENTRY,r.UNSELECTED_ENTRY);Dom.replaceClassName(n,r.SELECTED_KEY,r.UNSELECTED_KEY);Dom.replaceClassName(m,r.SELECTED_VAL,r.UNSELECTED_VAL);Dom.replaceClassName(k,r.UNSELECTED_KEY,r.SELECTED_KEY);Dom.replaceClassName(l,r.UNSELECTED_VAL,r.SELECTED_VAL);Dom.replaceClassName(q,r.UNSELECTED_ENTRY,r.SELECTED_ENTRY)};AutocompleteDataMgr.prototype.clear=function(){this.dataSource={}};AutocompleteDataMgr.prototype.getEntryNode=function(c){var d=document.getElementById(this.tableId);return c>=0?d.rows[c]:null};AutocompleteDataMgr.prototype.getKeyNode=function(c){var d=this.getEntryNode(c);return d?d.cells[0]:null};AutocompleteDataMgr.prototype.getValNode=function(c){var d=this.getEntryNode(c);return d?d.cells[1]:null};AutocompleteDataMgr.prototype.getEntryData=function(b){return this.dataSource[b]};AutocompleteDataMgr.prototype.getEntryKey=function(b){return this.getEntryData(b)?this.getEntryData(b).key:null};AutocompleteDataMgr.prototype.getEntryVal=function(b){return this.getEntryData(b)?this.getEntryData(b).val:null};AutocompleteDataMgr.prototype.fixIndex=function(b){if(b>=this.getDataLength()){b=-1}if(b<-1){b=this.getDataLength()-1}return b};AutocompleteDataMgr.prototype.setSelectable=function(b){this._selectable=b};AutocompleteDataMgr.prototype.selectable=function(){return this._selectable};function Autocomplete(b){return this._constructor.apply(this,arguments)}Autocomplete.prototype={EVENT:AUTOCOMPLETE_EVENT,keyMgr:AutocompleteKeyMgr,classNames:AutocompleteStyle,width:null,left:null,height:null,top:null,dataMgr:null,queryEventType:[!!window.ActiveXObject?"keyup":"input"],selectEventType:[navigator.userAgent.toLowerCase().indexOf("opera")!=-1?"keypress":"keydown"],instanceName:"",listenTextbox:null,returnTextbox:null,selectedIndex:-1,requestURL:"",disabled:false,userInputValue:"",textboxValue:"",userSelectedValue:"",container:null,selectEventInterval:100,interval:50,_completeItemFlag:0,_lastSelectTime:null,_textChangeTimer:null,_panel:null,_constructor:function(c){Object.extendJson(this,c||{});this.dataMgr=new AutocompleteDataMgr({instanceName:this.instanceName,classNames:this.classNames});var d=this.instanceName;this.returnTextbox=this.returnTextbox||this.listenTextbox;this.addTextboxEventListener();this._panel=new SuggestLayer($(this.container));this._panel.autoPosition=false;this._panel.autocompleteElements=[this.listenTextbox,this.returnTextbox];this.listenTextbox.setAttribute("autocomplete","off");this.textboxValue=this.getTextboxValue();return this},addTextboxEventListener:function(){var b=this;this.bindAllEventToTextbox(this.queryEventType,function(d){var a=window.event?event.keyCode:d.which;b.addTextChangeHandler();b.queryKeyEventHandler(d)});this.bindAllEventToTextbox(this.selectEventType,function(e){var a=(new Date()).valueOf();var f=parseInt(a-this._lastSelectTime,10)||0;if(f>=this.selectEventInterval){this._lastSelectTime=a;this.selectKeyEventHandler(e)}});BBEvent.observe(this.listenTextbox,"blur",function(){b.clearTextChangeTimer()});BBEvent.observe(this.listenTextbox,"focus",function(){b.addTextChangeHandler()});BBEvent.observe(this.listenTextbox,"keypress",function(){b.addTextChangeHandler()});if(!!window.ActiveXObject){BBEvent.observe(this.listenTextbox,"beforedeactivate",function(){if(b._completeItemFlag){window.event.cancelBubble=true;window.event.returnValue=false;b.listenTextbox.focus();b._completeItemFlag=0}})}},clearTextChangeTimer:function(){clearInterval(this._textChangeTimer)},addTextChangeHandler:function(){var b=this;b.clearTextChangeTimer();b._textChangeTimer=window.setInterval(function(){var a=b.getTextboxValue();if((b.textboxValue!=a&&b.userSelectedValue!=a)||0==a.trim().length){b.fireInputEvent(b.EVENT.INPUT,a)}b.textboxValue=a},b.interval)},bindAllEventToTextbox:function(f,h){if(!f.constructor){throw new Error(["Autocomplete","bindEventToTextbox","event type is invalid("+f+")"])}if(f.constructor!=Array){f=[f]}var g=f.length,j=this;for(var i=0;i<g;i++){BBEvent.observe(this.listenTextbox,f[i],function(a){return h.apply(j,arguments)})}},fireInputEvent:function(b){this.dispatchEvent(this.EVENT.INPUT,{selectedIndex:this.selectedIndex,dataSource:this.dataMgr.dataSource,inputValue:b})},clickHandler:function(b){this.listenTextbox.blur();this.entryChangeHandler(this.selectedIndex,b);this.setTextboxValue(this.dataMgr.getEntryKey(this.selectedIndex));this.enterKeyEventHandler()},overHandler:function(b){this.entryChangeHandler(this.selectedIndex,b)},outHandler:function(b){this.entryChangeHandler(b,this.selectedIndex)},mousedownHandler:function(f,d){var e=this;this._completeItemFlag=1},selectKeyEventHandler:function(h){if(this.textboxValue==""){return}var i=window.event?event.keyCode:h.which;var e=this.selectedIndex;switch(i){case this.keyMgr.UP:if(!this.dataMgr.selectable()){return}e--;break;case this.keyMgr.DOWN:if(!this.dataMgr.selectable()){return}e++;break;case this.keyMgr.ESC:this.hide();return;case this.keyMgr.ENTER:if(this._panel.isVisible()){BBEvent.preventDefault(h)}this.dispatchEvent(this.EVENT.ENTER);this.enterKeyEventHandler();return;default:return}if(!this._panel.isVisible()){this.show();e=this.selectedIndex}e=this.fixSelectedIndex(e);this.entryChangeHandler(this.selectedIndex,e);var g=this;if(-1!=this.selectedIndex){var j=g.dataMgr.getEntryKey(this.selectedIndex);g.userSelectedValue=j;g.setTextboxValue(j)}},dispatchEvent:function(c,d){d=d||{selectedIndex:this.selectedIndex,dataSource:this.dataMgr.dataSource,inputValue:this.userInputValue};CustEvent.fireEvent(this,c,d)},queryKeyEventHandler:function(c){var d=window.event?event.keyCode:c.which;if(!this.keyMgr.availableKeyCode(d)){return}this.userInputValue=this.getTextboxValue()},showDataSource:function(b){this.hide();this.setDataSource(b);this.resetSelectedIndex();this.show()},resetSelectedIndex:function(){this.selectedIndex=-1},fixSelectedIndex:function(b){return this.dataMgr.fixIndex(b)},entryChangeHandler:function(d,c){if(d!=c){this.dispatchEvent(this.EVENT.CHANGE)}this.dataMgr.gotoEntry(d,c);if(-1===c&&this.userInputValue){this.setTextboxValue(this.userInputValue)}this.selectedIndex=c},enterKeyEventHandler:function(){this.dispatchEvent(this.EVENT.SELECT);this.hide()},setDataSource:function(b){this.dataMgr.dataSource=b||[]},clearDataSource:function(){this.dataMgr.clear()},getTextboxValue:function(){return this.listenTextbox.value},setTextboxValue:function(b){if(null===b){return}if(this.returnTextbox.createTextRange){this.returnTextbox.createTextRange().text=b}else{this.returnTextbox.value=b}this.textboxValue=b},show:function(g,h,f,i,j){if(!!this.disabled){return}this.dispatchEvent(this.EVENT.SHOW);this._panel.setContent(this.dataMgr.format());this._panel.show()},hide:function(){this.dispatchEvent(this.EVENT.HIDE);this._panel.hide()}};