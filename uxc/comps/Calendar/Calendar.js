(function(d){!window.UXC&&(window.UXC={log:function(){}});var e=UXC.Calendar=window.Calendar={pickDate:function(a){f.pickDate(a)},init:function(a){f.initTrigger(a)},hide:function(){f.hide()},autoInit:true,defaultDateSpan:20,tpl:""};d(document).ready(function(a){setTimeout(function(b){if(!e.autoInit){return}e.init(d("input[type=text]"))},200);d(document).delegate("#UXCCalendar select.UYear","change",function(b){f.setNewYear(d(this).val())});d(document).delegate("#UXCCalendar select.UMonth","change",function(b){f.setNewMonth(d(this).val())});d(document).delegate("#UXCCalendar button.UConfirm","click",function(b){if(!f.setSelectedDate()){return}f.hide()});d(document).delegate("map[name=UXCCalendar_Year] area","click",function(b){b.preventDefault();var c=d(this),h=f.lastDateObj;if(!(h&&c.attr("action"))){return}if(c.attr("action").toLowerCase()=="up"){h.date.setFullYear(h.date.getFullYear()+1);h.initMinvalue.setFullYear(h.initMinvalue.getFullYear()+1);h.initMaxvalue.setFullYear(h.initMaxvalue.getFullYear()+1)}else{if(c.attr("action").toLowerCase()=="down"){h.date.setFullYear(h.date.getFullYear()-1);h.initMinvalue.setFullYear(h.initMinvalue.getFullYear()-1);h.initMaxvalue.setFullYear(h.initMaxvalue.getFullYear()-1)}}f.initDateLayout(h);UXC.log(c.attr("action"))});d(document).delegate("map[name=UXCCalendar_Month] area","click",function(b){b.preventDefault();var c=d(this),h=f.lastDateObj;if(!(h&&c.attr("action"))){return}if(c.attr("action").toLowerCase()=="up"){h.date.setMonth(h.date.getMonth()+1);h.initMinvalue.setMonth(h.initMinvalue.getMonth()+1);h.initMaxvalue.setMonth(h.initMaxvalue.getMonth()+1)}else{if(c.attr("action").toLowerCase()=="down"){h.date.setMonth(h.date.getMonth()-1);h.initMinvalue.setMonth(h.initMinvalue.getMonth()-1);h.initMaxvalue.setMonth(h.initMaxvalue.getMonth()-1)}}f.initDateLayout(h);UXC.log(c.attr("action"))});d(document).delegate("#UXCCalendar button.UClear","click",function(b){f.lastIpt&&f.lastIpt.length&&f.lastIpt.val("")});d(document).delegate("#UXCCalendar button.UCancel","click",function(b){f.hide()});d(document).on("click",function(b){if(f.isCalendarElement(b.target||b.targetElement)){return}var c=b.target||b.srcElement;if(c&&c.nodeName.toLowerCase()!="input"){f.hide();return}setTimeout(function(){if(f.lastIpt&&f.lastIpt.length&&c==f.lastIpt[0]){return}f.hide()},100)});d(document).delegate("input.UXCCalendar_btn","click",function(b){if(this.forCalendar){f.pickDate(this.forCalendar)}});d(document).delegate("input[datatype=date]","focus",function(b){f.pickDate(this)});d(document).delegate("#UXCCalendar","click",function(b){b.stopPropagation()});d(document).delegate("#UXCCalendar table a","click",function(b){b.preventDefault();var c=d(this),h=c.attr("date")||"";if(!h){return}if(c.parent("td").hasClass("unable")){return}UXC.log(h);f.setDate(h);f.hide()});d(window).on("scroll resize",function(b){var c=f.getLayout();if(!(c.is(":visible")&&f.lastIpt)){return}f.setPosition(f.lastIpt)})});var f={initTrigger:function(a){a.each(function(){var b=d(this),c=(b.prop("nodeName")||"").toLowerCase();UXC.log("\nCalendar.init: ",c);if(c!="input"){arguments.callee(a.query(d("input[type=text]")));return}if(d.trim(b.attr("datatype")||"").toLowerCase()!="date"){return}UXC.log("find Calendar item:",b.attr("name"),b.attr("id"),b.attr("datatype"));var h=b.find("+ input.UXCCalendar_btn");if(!h.length){b.after(h=d('<input type="button" class="UXCCalendar_btn"  />'))}h[0].forCalendar=b})},lastIpt:null,lastDateObj:null,isCalendarElement:function(b){b=d(b);var a=0;if(b.length){if(b.hasClass("UXCCalendar_btn")){a=1}if(b.prop("nodeName")&&b.attr("datatype")&&b.prop("nodeName").toLowerCase()=="input"&&b.attr("datatype").toLowerCase()=="date"){a=1}}return a},pickDate:function(b){UXC.log("Calendar.pickDate",new Date().getTime());b=d(b);if(!(b&&b.length)){return}f.lastIpt=b;var a=f.lastDateObj=f.getDate(b);UXC.log(a.date.getFullYear(),a.date.getMonth()+1,a.date.getDate());f.initDateLayout(a);f.setPosition(b)},initDateLayout:function(a){f.initYear(a);f.initMonth(a);f.initMonthDate(a)},initMonthDate:function(y){var t=f.getLayout();var v=f.maxDayOfMonth(y.date),c=y.date.getDay()||7,z=c+v,w=6,A=[],x,B,a,s,i;var u=f.cloneDate(y.date);u.setDate(1);var b=u.getDay()||7;if(b<2){u.setDate(-(b-1+6))}else{u.setDate(-(b-2))}A.push("<tr>");for(s=1;s<=42;s++){i=[];if(u.getDay()===0||u.getDay()==6){i.push("weekend")}if(!f.isSameMonth(y.date,u)){i.push("other")}if(y.minvalue&&u.getTime()<y.minvalue.getTime()){i.push("unable")}if(y.maxvalue&&u.getTime()>y.maxvalue.getTime()){i.push("unable")}if(f.isSameDay(y.date,u)){i.push("cur")}A.push('<td class="',i.join(" "),'">','<a href="javascript:" date="',u.getTime(),'">',u.getDate(),"</a></td>");u.setDate(u.getDate()+1);if(s%7===0&&s!=42){A.push("</tr><tr>")}}A.push("</tr>");t.find("table.UTableBorder tbody").html(d(A.join("")));UXC.log(B,x,v,c,z,w)},initMonth:function(b){var a=f.getLayout();d(a.find("select.UMonth").val(b.date.getMonth()))},initYear:function(o){var n=f.getLayout(),m=[],a,p,c=o.initMinvalue.getFullYear(),b=o.initMaxvalue.getFullYear();UXC.log(c,b);if(!p){p=o.date.getFullYear()}for(var i=c;i<=b;i++){a="";if(p===i){a=" selected "}m.push('<option value="'+i+'"'+a+">"+i+"</option>")}d(m.join("")).appendTo(n.find("select.UYear").html(""))},setNewYear:function(h){UXC.log(h);if(!f.lastDateObj){return}var c=f.maxDayOfMonth(f.lastDateObj.date),a=new Date(h,f.lastDateObj.date.getMonth(),1),b=f.maxDayOfMonth(a);if(c>b){a.setDate(b)}else{a.setDate(f.lastDateObj.date.getDate())}f.lastDateObj.date=a;f.initMonth(f.lastDateObj);f.initMonthDate(f.lastDateObj)},setNewMonth:function(h){UXC.log(h);if(!f.lastDateObj){return}var c=f.maxDayOfMonth(f.lastDateObj.date),a=new Date(f.lastDateObj.date.getFullYear(),h,1),b=f.maxDayOfMonth(a);if(c>b){a.setDate(b)}else{a.setDate(f.lastDateObj.date.getDate())}f.lastDateObj.date=a;f.initMonth(f.lastDateObj);f.initMonthDate(f.lastDateObj)},setPosition:function(r){var s=f.getLayout();s.css({left:"-9999px",top:"-9999px"}).show();var u=s.width(),c=s.height(),t=r.width(),b=r.height(),v=r.offset(),w,a,q=d(window).width(),x=d(window).height(),p=d(document).scrollTop();w=v.left;a=v.top+b+5;if((a+c-p)>x){UXC.log("y overflow");a=v.top-c-3;if(a<p){a=p}}s.css({left:w+"px",top:a+"px"});UXC.log(u,c,t,b,v.left,v.top,q,x);UXC.log(p,w,a)},hide:function(){f.getLayout().hide()},getLayout:function(){var a=d("#UXCCalendar");if(!a.length){a=d(e.tpl||f.tpl);a.attr("id","UXCCalendar").hide().appendTo(document.body);var b=d(['<option value="0">一月</option>','<option value="1">二月</option>','<option value="2">三月</option>','<option value="3">四月</option>','<option value="4">五月</option>','<option value="5">六月</option>','<option value="6">七月</option>','<option value="7">八月</option>','<option value="8">九月</option>','<option value="9">十月</option>','<option value="10">十一月</option>','<option value="11">十二月</option>'].join("")).appendTo(a.find("select.UMonth"));a.hide()}return a},getDate:function(a){var b={date:0,minvalue:0,maxvalue:0,initMinvalue:0,initMaxvalue:0},c;if(c=f.parseDate(a.val())){b.date=c}else{b.date=new Date()}b.minvalue=f.parseDate(a.attr("minvalue"));b.maxvalue=f.parseDate(a.attr("maxvalue"));b.minvalue&&(b.initMinvalue=f.cloneDate(b.minvalue));b.maxvalue&&(b.initMaxvalue=f.cloneDate(b.maxvalue));if(!b.initMinvalue){b.initMinvalue=f.cloneDate(b.date);b.initMinvalue.setFullYear(b.initMinvalue.getFullYear()-e.defaultDateSpan)}if(!b.initMaxvalue){b.initMaxvalue=f.cloneDate(b.date);b.initMaxvalue.setFullYear(b.initMaxvalue.getFullYear()+e.defaultDateSpan)}return b},setDate:function(i){if(!(i&&f.lastIpt&&f.lastIpt.length)){return}var a=new Date(),b="-";a.setTime(i);var j=f.lastIpt.attr("dateFormat");if(j){j=j.replace(/[\da-zA-Z]/g,"");if(j.length){j=j.slice(0,1)}b=j}var c=[a.getFullYear(),f.intPad(a.getMonth()+1),f.intPad(a.getDate())].join(b);f.lastIpt.val(c)},setSelectedDate:function(){var a;a=f.getLayout().find("table td.cur a");if(a.parent("td").hasClass("unable")){return 0}a&&a.length&&a.attr("date")&&f.setDate(a.attr("date"));return 1},parseDate:function(b){var c=/[^\d]/g,a,b=b||"";b&&(b=b.replace(c,""));if(b&&b.length==8){a=new Date(parseInt(b.slice(0,4),10),parseInt(b.slice(4,6),10)-1,parseInt(b.slice(6,8),10))}return a},cloneDate:function(b){var a=new Date();a.setTime(b.getTime());return a},isSameDay:function(a,b){return[a.getFullYear(),a.getMonth(),a.getDate()].join()===[b.getFullYear(),b.getMonth(),b.getDate()].join()},isSameMonth:function(a,b){return[a.getFullYear(),a.getMonth()].join()===[b.getFullYear(),b.getMonth()].join()},maxDayOfMonth:function(c){var b,a=new Date(c.getFullYear(),c.getMonth()+1);a.setDate(a.getDate()-1);b=a.getDate();return b},intPad:function(a,b){if(typeof b=="undefined"){b=2}a=new Array(b+1).join("0")+a;return a.slice(a.length-b)},tpl:['<div id="UXCCalendar" class="UXCCalendar">\n','    <div class="UHeader">\n','        <select class="UYear"></select>\n','        <img class="UImg yearctl" align="absMiddle" usemap="#UXCCalendar_Year" />\n','        <map name="UXCCalendar_Year"><area shape="rect" coords="0,0,13,8" href="#" action="up"><area shape="rect" coords="0,10,13,17" href="#" action="down"></map>\n','        <select class="UMonth"></select>\n','        <img class="UImg monthctl" align="absMiddle" usemap="#UXCCalendar_Month"  />\n','        <map name="UXCCalendar_Month"><area shape="rect" coords="0,0,13,8" href="#" action="up"><area shape="rect" coords="0,10,13,17" href="#" action="down"></map>\n',"    </div>\n",'    <table class="UTable">\n',"        <thead>\n","            <tr>\n","                <th>一</th>\n","                <th>二</th>\n","                <th>三</th>\n","                <th>四</th>\n","                <th>五</th>\n","                <th>六</th>\n","                <th>日</th>\n","            </tr>\n","        </thead>\n","   </table>\n",'   <table class="UTable UTableBorder">\n',"        <tbody>\n","           <!--<tr>\n",'                <td class="cur"><a href="#">2</a></td>\n','                <td class="unable"><a href="#">2</a></td>\n','                <td class="weekend cur"><a href="#">6</a></td>\n','                <td class="weekend hover"><a href="#">13</a></td>\n','                <td class="weekend other"><a href="#">41</a></td>\n','                <td class="weekend other"><a href="#">42</a></td>\n',"            </tr>\n-->","        </tbody>\n","    </table>\n",'    <div class="UFooter">\n','        <button type="button" class="UConfirm">确定</button>\n','        <button type="button" class="UClear">清空</button>\n','        <button type="button" class="UCancel">取消</button>\n',"    </div>\n","</div>\n"].join("")}}(jQuery));