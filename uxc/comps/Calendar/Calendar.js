(function(e){!window.UXC&&(window.UXC={log:function(){}});var f=UXC.Calendar=window.Calendar={pickDate:function(a){d.pickDate(a)},init:function(a){d.initTrigger(a)},hide:function(){d.hide()},autoInit:true,defaultDateSpan:20,tpl:""};e(document).ready(function(a){setTimeout(function(b){if(!f.autoInit){return}f.init(e("input[type=text]"))},200);e(document).delegate("#UXCCalendar select.UYear","change",function(b){d.setNewYear(e(this).val())});e(document).delegate("#UXCCalendar select.UMonth","change",function(b){d.setNewMonth(e(this).val())});e(document).delegate("#UXCCalendar button.UConfirm","click",function(b){if(!d.setSelectedDate()){return}d.hide()});e(document).delegate("map[name=UXCCalendar_Year] area","click",function(c){c.preventDefault();var h=e(this),b=d.lastDateObj;if(!(b&&h.attr("action"))){return}if(h.attr("action").toLowerCase()=="up"){b.date.setFullYear(b.date.getFullYear()+1);b.initMinvalue.setFullYear(b.initMinvalue.getFullYear()+1);b.initMaxvalue.setFullYear(b.initMaxvalue.getFullYear()+1)}else{if(h.attr("action").toLowerCase()=="down"){b.date.setFullYear(b.date.getFullYear()-1);b.initMinvalue.setFullYear(b.initMinvalue.getFullYear()-1);b.initMaxvalue.setFullYear(b.initMaxvalue.getFullYear()-1)}}d.initDateLayout(b);UXC.log(h.attr("action"))});e(document).delegate("map[name=UXCCalendar_Month] area","click",function(c){c.preventDefault();var h=e(this),b=d.lastDateObj;if(!(b&&h.attr("action"))){return}if(h.attr("action").toLowerCase()=="up"){b.date.setMonth(b.date.getMonth()+1);b.initMinvalue.setMonth(b.initMinvalue.getMonth()+1);b.initMaxvalue.setMonth(b.initMaxvalue.getMonth()+1)}else{if(h.attr("action").toLowerCase()=="down"){b.date.setMonth(b.date.getMonth()-1);b.initMinvalue.setMonth(b.initMinvalue.getMonth()-1);b.initMaxvalue.setMonth(b.initMaxvalue.getMonth()-1)}}d.initDateLayout(b);UXC.log(h.attr("action"))});e(document).delegate("#UXCCalendar button.UClear","click",function(b){d.lastIpt&&d.lastIpt.length&&d.lastIpt.val("")});e(document).delegate("#UXCCalendar button.UCancel","click",function(b){d.hide()});e(document).on("click",function(c){if(d.isCalendarElement(c.target||c.targetElement)){return}var b=c.target||c.srcElement;if(b&&b.nodeName.toLowerCase()!="input"){d.hide();return}setTimeout(function(){if(d.lastIpt&&d.lastIpt.length&&b==d.lastIpt[0]){return}d.hide()},100)});e(document).delegate("input.UXCCalendar_btn","click",function(b){if(this.forCalendar){d.pickDate(this.forCalendar)}});e(document).delegate("input[datatype=date]","focus",function(b){d.pickDate(this)});e(document).delegate("#UXCCalendar","click",function(b){b.stopPropagation()});e(document).delegate("#UXCCalendar table a","click",function(c){c.preventDefault();var h=e(this),b=h.attr("date")||"";if(!b){return}if(h.parent("td").hasClass("unable")){return}UXC.log(b);d.setDate(b);d.hide()});e(window).on("scroll resize",function(c){var b=d.getLayout();if(!(b.is(":visible")&&d.lastIpt)){return}d.setPosition(d.lastIpt)})});var d={initTrigger:function(a){a.each(function(){var c=e(this),h=(c.prop("nodeName")||"").toLowerCase();UXC.log("\nCalendar.init: ",h);if(h!="input"){arguments.callee(a.query(e("input[type=text]")));return}if(e.trim(c.attr("datatype")||"").toLowerCase()!="date"){return}UXC.log("find Calendar item:",c.attr("name"),c.attr("id"),c.attr("datatype"));var b=c.find("+ input.UXCCalendar_btn");if(!b.length){c.after(b=e('<input type="button" class="UXCCalendar_btn"  />'))}b[0].forCalendar=c})},lastIpt:null,lastDateObj:null,isCalendarElement:function(b){b=e(b);var a=0;if(b.length){if(b.hasClass("UXCCalendar_btn")){a=1}if(b.prop("nodeName")&&b.attr("datatype")&&b.prop("nodeName").toLowerCase()=="input"&&b.attr("datatype").toLowerCase()=="date"){a=1}}return a},pickDate:function(b){UXC.log("Calendar.pickDate",new Date().getTime());b=e(b);if(!(b&&b.length)){return}d.lastIpt=b;var a=d.lastDateObj=d.getDate(b);UXC.log(a.date.getFullYear(),a.date.getMonth()+1,a.date.getDate());d.initDateLayout(a);d.setPosition(b)},initDateLayout:function(a){d.initYear(a);d.initMonth(a);d.initMonthDate(a)},initMonthDate:function(c){var a=d.getLayout();var b=d.maxDayOfMonth(c.date),u=c.date.getDay()||7,i=u+b,y=6,A=[],z,B,s,w,v;var x=d.cloneDate(c.date);x.setDate(1);var t=x.getDay()||7;if(t<2){x.setDate(-(t-1+6))}else{x.setDate(-(t-2))}A.push("<tr>");for(w=1;w<=42;w++){v=[];if(x.getDay()===0||x.getDay()==6){v.push("weekend")}if(!d.isSameMonth(c.date,x)){v.push("other")}if(c.minvalue&&x.getTime()<c.minvalue.getTime()){v.push("unable")}if(c.maxvalue&&x.getTime()>c.maxvalue.getTime()){v.push("unable")}if(d.isSameDay(c.date,x)){v.push("cur")}A.push('<td class="',v.join(" "),'">','<a href="javascript:" date="',x.getTime(),'">',x.getDate(),"</a></td>");x.setDate(x.getDate()+1);if(w%7===0&&w!=42){A.push("</tr><tr>")}}A.push("</tr>");a.find("table.UTableBorder tbody").html(e(A.join("")));UXC.log(B,z,b,u,i,y)},initMonth:function(b){var a=d.getLayout();e(a.find("select.UMonth").val(b.date.getMonth()))},initYear:function(b){var a=d.getLayout(),i=[],n,m,o=b.initMinvalue.getFullYear(),c=b.initMaxvalue.getFullYear();UXC.log(o,c);if(!m){m=b.date.getFullYear()}for(var p=o;p<=c;p++){n="";if(m===p){n=" selected "}i.push('<option value="'+p+'"'+n+">"+p+"</option>")}e(i.join("")).appendTo(a.find("select.UYear").html(""))},setNewYear:function(b){UXC.log(b);if(!d.lastDateObj){return}var a=d.maxDayOfMonth(d.lastDateObj.date),c=new Date(b,d.lastDateObj.date.getMonth(),1),h=d.maxDayOfMonth(c);if(a>h){c.setDate(h)}else{c.setDate(d.lastDateObj.date.getDate())}d.lastDateObj.date=c;d.initMonth(d.lastDateObj);d.initMonthDate(d.lastDateObj)},setNewMonth:function(b){UXC.log(b);if(!d.lastDateObj){return}var a=d.maxDayOfMonth(d.lastDateObj.date),c=new Date(d.lastDateObj.date.getFullYear(),b,1),h=d.maxDayOfMonth(c);if(a>h){c.setDate(h)}else{c.setDate(d.lastDateObj.date.getDate())}d.lastDateObj.date=c;d.initMonth(d.lastDateObj);d.initMonthDate(d.lastDateObj)},setPosition:function(x){var a=d.getLayout();a.css({left:"-9999px",top:"-9999px"}).show();var c=a.width(),u=a.height(),b=x.width(),t=x.height(),p=x.offset(),q,s,w=e(window).width(),r=e(window).height(),v=e(document).scrollTop();q=p.left;s=p.top+t+5;if((s+u-v)>r){UXC.log("y overflow");s=p.top-u-3;if(s<v){s=v}}a.css({left:q+"px",top:s+"px"});UXC.log(c,u,b,t,p.left,p.top,w,r);UXC.log(v,q,s)},hide:function(){d.getLayout().hide()},getLayout:function(){var a=e("#UXCCalendar");if(!a.length){a=e(f.tpl||d.tpl);a.attr("id","UXCCalendar").hide().appendTo(document.body);var b=e(['<option value="0">一月</option>','<option value="1">二月</option>','<option value="2">三月</option>','<option value="3">四月</option>','<option value="4">五月</option>','<option value="5">六月</option>','<option value="6">七月</option>','<option value="7">八月</option>','<option value="8">九月</option>','<option value="9">十月</option>','<option value="10">十一月</option>','<option value="11">十二月</option>'].join("")).appendTo(a.find("select.UMonth"));a.hide()}return a},getDate:function(c){var a={date:0,minvalue:0,maxvalue:0,initMinvalue:0,initMaxvalue:0},b;if(b=d.parseDate(c.val())){a.date=b}else{a.date=new Date()}a.minvalue=d.parseDate(c.attr("minvalue"));a.maxvalue=d.parseDate(c.attr("maxvalue"));a.minvalue&&(a.initMinvalue=d.cloneDate(a.minvalue));a.maxvalue&&(a.initMaxvalue=d.cloneDate(a.maxvalue));if(!a.initMinvalue){a.initMinvalue=d.cloneDate(a.date);a.initMinvalue.setFullYear(a.initMinvalue.getFullYear()-f.defaultDateSpan)}if(!a.initMaxvalue){a.initMaxvalue=d.cloneDate(a.date);a.initMaxvalue.setFullYear(a.initMaxvalue.getFullYear()+f.defaultDateSpan)}return a},setDate:function(a){if(!(a&&d.lastIpt&&d.lastIpt.length)){return}var c=new Date(),i="-";c.setTime(a);var b=d.lastIpt.attr("dateFormat");if(b){b=b.replace(/[\da-zA-Z]/g,"");if(b.length){b=b.slice(0,1)}i=b}var j=[c.getFullYear(),d.intPad(c.getMonth()+1),d.intPad(c.getDate())].join(i);d.lastIpt.val(j)},setSelectedDate:function(){var a;a=d.getLayout().find("table td.cur a");if(a.parent("td").hasClass("unable")){return 0}a&&a.length&&a.attr("date")&&d.setDate(a.attr("date"));return 1},parseDate:function(a){var b=/[^\d]/g,c,a=a||"";a&&(a=a.replace(b,""));if(a&&a.length==8){c=new Date(parseInt(a.slice(0,4),10),parseInt(a.slice(4,6),10)-1,parseInt(a.slice(6,8),10))}return c},cloneDate:function(b){var a=new Date();a.setTime(b.getTime());return a},isSameDay:function(a,b){return[a.getFullYear(),a.getMonth(),a.getDate()].join()===[b.getFullYear(),b.getMonth(),b.getDate()].join()},isSameMonth:function(a,b){return[a.getFullYear(),a.getMonth()].join()===[b.getFullYear(),b.getMonth()].join()},maxDayOfMonth:function(b){var a,c=new Date(b.getFullYear(),b.getMonth()+1);c.setDate(c.getDate()-1);a=c.getDate();return a},intPad:function(a,b){if(typeof b=="undefined"){b=2}a=new Array(b+1).join("0")+a;return a.slice(a.length-b)},tpl:['<div id="UXCCalendar" class="UXCCalendar">\n','    <div class="UHeader">\n','        <select class="UYear"></select>\n','        <img class="UImg yearctl" align="absMiddle" usemap="#UXCCalendar_Year" />\n','        <map name="UXCCalendar_Year"><area shape="rect" coords="0,0,13,8" href="#" action="up"><area shape="rect" coords="0,10,13,17" href="#" action="down"></map>\n','        <select class="UMonth"></select>\n','        <img class="UImg monthctl" align="absMiddle" usemap="#UXCCalendar_Month"  />\n','        <map name="UXCCalendar_Month"><area shape="rect" coords="0,0,13,8" href="#" action="up"><area shape="rect" coords="0,10,13,17" href="#" action="down"></map>\n',"    </div>\n",'    <table class="UTable">\n',"        <thead>\n","            <tr>\n","                <th>一</th>\n","                <th>二</th>\n","                <th>三</th>\n","                <th>四</th>\n","                <th>五</th>\n","                <th>六</th>\n","                <th>日</th>\n","            </tr>\n","        </thead>\n","   </table>\n",'   <table class="UTable UTableBorder">\n',"        <tbody>\n","           <!--<tr>\n",'                <td class="cur"><a href="#">2</a></td>\n','                <td class="unable"><a href="#">2</a></td>\n','                <td class="weekend cur"><a href="#">6</a></td>\n','                <td class="weekend hover"><a href="#">13</a></td>\n','                <td class="weekend other"><a href="#">41</a></td>\n','                <td class="weekend other"><a href="#">42</a></td>\n',"            </tr>\n-->","        </tbody>\n","    </table>\n",'    <div class="UFooter">\n','        <button type="button" class="UConfirm">确定</button>\n','        <button type="button" class="UClear">清空</button>\n','        <button type="button" class="UCancel">取消</button>\n',"    </div>\n","</div>\n"].join("")}}(jQuery));