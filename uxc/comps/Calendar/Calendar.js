(function(a){!window.UXC&&(window.UXC={log:function(){}});var c=UXC.Calendar=window.Calendar={pickDate:function(d){b.pickDate(d)},init:function(d){b.initTrigger(d)},hide:function(){b.hide()},autoInit:true,defaultDateSpan:20,tpl:""};a(document).ready(function(d){setTimeout(function(e){if(!c.autoInit){return}c.init(a("input[type=text]"))},200);a(document).delegate("#UXCCalendar select.UYear","change",function(e){b.setNewYear(a(this).val())});a(document).delegate("#UXCCalendar select.UMonth","change",function(e){b.setNewMonth(a(this).val())});a(document).delegate("#UXCCalendar button.UConfirm","click",function(e){if(!b.setSelectedDate()){return}b.hide()});a(document).delegate("map[name=UXCCalendar_Year] area","click",function(f){f.preventDefault();var e=a(this),g=b.lastDateObj;if(!(g&&e.attr("action"))){return}if(e.attr("action").toLowerCase()=="up"){g.date.setFullYear(g.date.getFullYear()+1);g.initMinvalue.setFullYear(g.initMinvalue.getFullYear()+1);g.initMaxvalue.setFullYear(g.initMaxvalue.getFullYear()+1)}else{if(e.attr("action").toLowerCase()=="down"){g.date.setFullYear(g.date.getFullYear()-1);g.initMinvalue.setFullYear(g.initMinvalue.getFullYear()-1);g.initMaxvalue.setFullYear(g.initMaxvalue.getFullYear()-1)}}b.initDateLayout(g);UXC.log(e.attr("action"))});a(document).delegate("map[name=UXCCalendar_Month] area","click",function(f){f.preventDefault();var e=a(this),g=b.lastDateObj;if(!(g&&e.attr("action"))){return}if(e.attr("action").toLowerCase()=="up"){g.date.setMonth(g.date.getMonth()+1);g.initMinvalue.setMonth(g.initMinvalue.getMonth()+1);g.initMaxvalue.setMonth(g.initMaxvalue.getMonth()+1)}else{if(e.attr("action").toLowerCase()=="down"){g.date.setMonth(g.date.getMonth()-1);g.initMinvalue.setMonth(g.initMinvalue.getMonth()-1);g.initMaxvalue.setMonth(g.initMaxvalue.getMonth()-1)}}b.initDateLayout(g);UXC.log(e.attr("action"))});a(document).delegate("#UXCCalendar button.UClear","click",function(e){b.lastIpt&&b.lastIpt.length&&b.lastIpt.val("")});a(document).delegate("#UXCCalendar button.UCancel","click",function(e){b.hide()});a(document).on("click",function(e){if(b.isCalendarElement(e.target||e.targetElement)){return}var f=e.target||e.srcElement;if(f&&f.nodeName.toLowerCase()!="input"){b.hide();return}setTimeout(function(){if(b.lastIpt&&b.lastIpt.length&&f==b.lastIpt[0]){return}b.hide()},100)});a(document).delegate("input.UXCCalendar_btn","click",function(e){if(this.forCalendar){b.pickDate(this.forCalendar)}});a(document).delegate("input[datatype=date]","focus",function(e){b.pickDate(this)});a(document).delegate("#UXCCalendar","click",function(e){e.stopPropagation()});a(document).delegate("#UXCCalendar table a","click",function(f){f.preventDefault();var e=a(this),g=e.attr("date")||"";if(!g){return}if(e.parent("td").hasClass("unable")){return}UXC.log(g);b.setDate(g);b.hide()});a(window).on("scroll resize",function(e){var f=b.getLayout();if(!(f.is(":visible")&&b.lastIpt)){return}b.setPosition(b.lastIpt)})});var b={initTrigger:function(d){d.each(function(){var f=a(this),e=(f.prop("nodeName")||"").toLowerCase();UXC.log("\nCalendar.init: ",e);if(e!="input"){arguments.callee(d.query(a("input[type=text]")));return}if(a.trim(f.attr("datatype")||"").toLowerCase()!="date"){return}UXC.log("find Calendar item:",f.attr("name"),f.attr("id"),f.attr("datatype"));var g=f.find("+ input.UXCCalendar_btn");if(!g.length){f.after(g=a('<input type="button" class="UXCCalendar_btn"  />'))}g[0].forCalendar=f})},lastIpt:null,lastDateObj:null,isCalendarElement:function(d){d=a(d);var e=0;if(d.length){if(d.hasClass("UXCCalendar_btn")){e=1}if(d.prop("nodeName")&&d.attr("datatype")&&d.prop("nodeName").toLowerCase()=="input"&&d.attr("datatype").toLowerCase()=="date"){e=1}}return e},pickDate:function(d){UXC.log("Calendar.pickDate",new Date().getTime());d=a(d);if(!(d&&d.length)){return}b.lastIpt=d;var e=b.lastDateObj=b.getDate(d);UXC.log(e.date.getFullYear(),e.date.getMonth()+1,e.date.getDate());b.initDateLayout(e);b.setPosition(d)},initDateLayout:function(d){b.initYear(d);b.initMonth(d);b.initMonthDate(d)},initMonthDate:function(p){var r=b.getLayout();var q=b.maxDayOfMonth(p.date),l=p.date.getDay()||7,o=l+q,g=6,e=[],f,d,n,j,k;var h=b.cloneDate(p.date);h.setDate(1);var m=h.getDay()||7;if(m<2){h.setDate(-(m-1+6))}else{h.setDate(-(m-2))}e.push("<tr>");for(j=1;j<=42;j++){k=[];if(h.getDay()===0||h.getDay()==6){k.push("weekend")}if(!b.isSameMonth(p.date,h)){k.push("other")}if(p.minvalue&&h.getTime()<p.minvalue.getTime()){k.push("unable")}if(p.maxvalue&&h.getTime()>p.maxvalue.getTime()){k.push("unable")}if(b.isSameDay(p.date,h)){k.push("cur")}e.push('<td class="',k.join(" "),'">','<a href="javascript:" date="',h.getTime(),'">',h.getDate(),"</a></td>");h.setDate(h.getDate()+1);if(j%7===0&&j!=42){e.push("</tr><tr>")}}e.push("</tr>");r.find("table.UTableBorder tbody").html(a(e.join("")));UXC.log(d,f,q,l,o,g)},initMonth:function(d){var e=b.getLayout();a(e.find("select.UMonth").val(d.date.getMonth()))},initYear:function(k){var l=b.getLayout(),h=[],f,g,e=k.initMinvalue.getFullYear(),j=k.initMaxvalue.getFullYear();UXC.log(e,j);if(!g){g=k.date.getFullYear()}for(var d=e;d<=j;d++){f="";if(g===d){f=" selected "}h.push('<option value="'+d+'"'+f+">"+d+"</option>")}a(h.join("")).appendTo(l.find("select.UYear").html(""))},setNewYear:function(f){UXC.log(f);if(!b.lastDateObj){return}var g=b.maxDayOfMonth(b.lastDateObj.date),e=new Date(f,b.lastDateObj.date.getMonth(),1),d=b.maxDayOfMonth(e);if(g>d){e.setDate(d)}else{e.setDate(b.lastDateObj.date.getDate())}b.lastDateObj.date=e;b.initMonth(b.lastDateObj);b.initMonthDate(b.lastDateObj)},setNewMonth:function(f){UXC.log(f);if(!b.lastDateObj){return}var g=b.maxDayOfMonth(b.lastDateObj.date),e=new Date(b.lastDateObj.date.getFullYear(),f,1),d=b.maxDayOfMonth(e);if(g>d){e.setDate(d)}else{e.setDate(b.lastDateObj.date.getDate())}b.lastDateObj.date=e;b.initMonth(b.lastDateObj);b.initMonthDate(b.lastDateObj)},setPosition:function(d){var o=b.getLayout();o.css({left:"-9999px",top:"-9999px"}).show();var m=o.width(),g=o.height(),n=d.width(),h=d.height(),l=d.offset(),k,i,e=a(window).width(),j=a(window).height(),f=a(document).scrollTop();k=l.left;i=l.top+h+5;if((i+g-f)>j){UXC.log("y overflow");i=l.top-g-3;if(i<f){i=f}}o.css({left:k+"px",top:i+"px"});UXC.log(m,g,n,h,l.left,l.top,e,j);UXC.log(f,k,i)},hide:function(){b.getLayout().hide()},getLayout:function(){var e=a("#UXCCalendar");if(!e.length){e=a(c.tpl||b.tpl);e.attr("id","UXCCalendar").hide().appendTo(document.body);var d=a(['<option value="0">一月</option>','<option value="1">二月</option>','<option value="2">三月</option>','<option value="3">四月</option>','<option value="4">五月</option>','<option value="5">六月</option>','<option value="6">七月</option>','<option value="7">八月</option>','<option value="8">九月</option>','<option value="9">十月</option>','<option value="10">十一月</option>','<option value="11">十二月</option>'].join("")).appendTo(e.find("select.UMonth"));e.hide()}return e},getDate:function(d){var f={date:0,minvalue:0,maxvalue:0,initMinvalue:0,initMaxvalue:0},e;if(e=b.parseDate(d.val())){f.date=e}else{f.date=new Date()}f.minvalue=b.parseDate(d.attr("minvalue"));f.maxvalue=b.parseDate(d.attr("maxvalue"));f.minvalue&&(f.initMinvalue=b.cloneDate(f.minvalue));f.maxvalue&&(f.initMaxvalue=b.cloneDate(f.maxvalue));if(!f.initMinvalue){f.initMinvalue=b.cloneDate(f.date);f.initMinvalue.setFullYear(f.initMinvalue.getFullYear()-c.defaultDateSpan)}if(!f.initMaxvalue){f.initMaxvalue=b.cloneDate(f.date);f.initMaxvalue.setFullYear(f.initMaxvalue.getFullYear()+c.defaultDateSpan)}return f},setDate:function(h){if(!(h&&b.lastIpt&&b.lastIpt.length)){return}var f=new Date(),e="-";f.setTime(h);var g=b.lastIpt.attr("dateFormat");if(g){g=g.replace(/[\da-zA-Z]/g,"");if(g.length){g=g.slice(0,1)}e=g}var d=[f.getFullYear(),b.intPad(f.getMonth()+1),b.intPad(f.getDate())].join(e);b.lastIpt.val(d)},setSelectedDate:function(){var d;d=b.getLayout().find("table td.cur a");if(d.parent("td").hasClass("unable")){return 0}d&&d.length&&d.attr("date")&&b.setDate(d.attr("date"));return 1},parseDate:function(f){var e=/[^\d]/g,d,f=f||"";f&&(f=f.replace(e,""));if(f&&f.length==8){d=new Date(parseInt(f.slice(0,4),10),parseInt(f.slice(4,6),10)-1,parseInt(f.slice(6,8),10))}return d},cloneDate:function(e){var f=new Date();f.setTime(e.getTime());return f},isSameDay:function(e,d){return[e.getFullYear(),e.getMonth(),e.getDate()].join()===[d.getFullYear(),d.getMonth(),d.getDate()].join()},isSameMonth:function(e,d){return[e.getFullYear(),e.getMonth()].join()===[d.getFullYear(),d.getMonth()].join()},maxDayOfMonth:function(e){var f,d=new Date(e.getFullYear(),e.getMonth()+1);d.setDate(d.getDate()-1);f=d.getDate();return f},intPad:function(e,d){if(typeof d=="undefined"){d=2}e=new Array(d+1).join("0")+e;return e.slice(e.length-d)},tpl:['<div id="UXCCalendar" class="UXCCalendar">\n','    <div class="UHeader">\n','        <select class="UYear"></select>\n','        <img class="UImg yearctl" align="absMiddle" usemap="#UXCCalendar_Year" />\n','        <map name="UXCCalendar_Year"><area shape="rect" coords="0,0,13,8" href="#" action="up"><area shape="rect" coords="0,10,13,17" href="#" action="down"></map>\n','        <select class="UMonth"></select>\n','        <img class="UImg monthctl" align="absMiddle" usemap="#UXCCalendar_Month"  />\n','        <map name="UXCCalendar_Month"><area shape="rect" coords="0,0,13,8" href="#" action="up"><area shape="rect" coords="0,10,13,17" href="#" action="down"></map>\n',"    </div>\n",'    <table class="UTable">\n',"        <thead>\n","            <tr>\n","                <th>一</th>\n","                <th>二</th>\n","                <th>三</th>\n","                <th>四</th>\n","                <th>五</th>\n","                <th>六</th>\n","                <th>日</th>\n","            </tr>\n","        </thead>\n","   </table>\n",'   <table class="UTable UTableBorder">\n',"        <tbody>\n","           <!--<tr>\n",'                <td class="cur"><a href="#">2</a></td>\n','                <td class="unable"><a href="#">2</a></td>\n','                <td class="weekend cur"><a href="#">6</a></td>\n','                <td class="weekend hover"><a href="#">13</a></td>\n','                <td class="weekend other"><a href="#">41</a></td>\n','                <td class="weekend other"><a href="#">42</a></td>\n',"            </tr>\n-->","        </tbody>\n","    </table>\n",'    <div class="UFooter">\n','        <button type="button" class="UConfirm">确定</button>\n','        <button type="button" class="UClear">清空</button>\n','        <button type="button" class="UCancel">取消</button>\n',"    </div>\n","</div>\n"].join("")}}(jQuery));